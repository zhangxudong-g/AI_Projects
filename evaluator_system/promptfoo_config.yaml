# Promptfoo 配置文件
# 用于评测不同模型/Prompt的文档忠实度

version: "2"
defaultTest:
  options:
    # 设置评估指标
    assert:
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return result.pass === true;
        message: "评测未通过 - 文档不符合忠实度要求"

tests:
  # 测试用例1：基本功能测试
  - description: "测试基本功能 - 正确引用事实"
    vars:
      facts_file: "./examples/facts_basic.json"
      wiki_file: "./examples/wiki_basic.json"
    provider: 
      id: "exec:python src/v1_evaluator.py --facts {{facts_file}} --wiki {{wiki_file}} --out /tmp/result.json && cat /tmp/result.json"
    assert:
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return result.pass === true && result.metrics.faithfulness >= 0.95;
        message: "基本功能测试失败"

  # 测试用例2：检测幻觉
  - description: "测试幻觉检测 - 包含越权推断的文档"
    vars:
      facts_file: "./examples/facts_no_call.json"  # 不包含调用信息的事实
      wiki_file: "./examples/wiki_with_over_inference.json"  # 包含越权推断的文档
    provider:
      id: "exec:python src/v1_evaluator.py --facts {{facts_file}} --wiki {{wiki_file}} --out /tmp/result.json && cat /tmp/result.json"
    assert:
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return result.pass === false && result.metrics.hallucination_rate > 0;
        message: "未能正确检测到幻觉"

  # 测试用例3：关键事实覆盖率
  - description: "测试关键事实覆盖率"
    vars:
      facts_file: "./examples/facts_with_calls_writes.json"
      wiki_file: "./examples/wiki_partial_coverage.json"
    provider:
      id: "exec:python src/v1_evaluator.py --facts {{facts_file}} --wiki {{wiki_file}} --out /tmp/result.json && cat /tmp/result.json"
    assert:
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return result.metrics.key_fact_recall < 0.85;
        message: "关键事实覆盖率计算不正确"

prompts:
  - "N/A"  # 我们的评测系统不需要生成提示，只需要评估现有文档

providers:
  - id: "exec:python src/v1_evaluator.py --facts {{facts_file}} --wiki {{wiki_file}} --out /tmp/result.json && cat /tmp/result.json"