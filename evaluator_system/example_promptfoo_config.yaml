# 示例Promptfoo配置文件
# 用于测试V1评测系统与Promptfoo的集成

version: "2"

# 默认测试配置
defaultTest:
  options:
    assert:
      - type: javascript
        value: |
          const result = JSON.parse(output);
          return result.pass === true;
        message: "评测未通过 - 文档不符合忠实度要求"

# 测试用例
tests:
  # 基础功能测试
  - description: "测试用户服务文档质量"
    vars:
      facts_file: "./sample_project/source_code/user_service.py"
      wiki_file: "./sample_project/wiki_docs/user_service.md"
    provider: 
      id: "exec:python simple_evaluator.py --code {{facts_file}} --wiki-md {{wiki_file}} --output /tmp/user_service_result.json && type /tmp/user_service_result.json"
    assert:
      - type: javascript
        value: |
          const fs = require('fs');
          const resultStr = fs.readFileSync('/tmp/user_service_result.json', 'utf8');
          const result = JSON.parse(resultStr);
          return result.pass === true;
        message: "用户服务文档评测未通过"

  # 幻觉检测测试
  - description: "测试幻觉检测功能"
    vars:
      facts_file: "./examples/facts_no_call.json"
      wiki_file: "./examples/wiki_with_over_inference.json"
    provider:
      id: "exec:python src/v1_evaluator.py --facts {{facts_file}} --wiki {{wiki_file}} --out /tmp/hallucination_result.json && type /tmp/hallucination_result.json"
    assert:
      - type: javascript
        value: |
          const fs = require('fs');
          const resultStr = fs.readFileSync('/tmp/hallucination_result.json', 'utf8');
          const result = JSON.parse(resultStr);
          return result.metrics.hallucination_rate > 0;
        message: "未能正确检测到幻觉"

# 提示模板（如果需要生成Wiki文档）
prompts:
  - |
    基于以下代码生成文档：
    {{code}}
    
    请生成一个JSON格式的Wiki文档，格式如下：
    {
      "method": "method_name",
      "claims": [
        { "text": "描述", "fact_refs": ["calls:service.method"] }
      ]
    }

# 评估选项
evaluateOptions:
  maxConcurrency: 1
  showProgressBar: true