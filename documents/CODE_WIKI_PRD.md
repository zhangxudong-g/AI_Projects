# Code Wiki 产品需求文档 (PRD)

## 1. 项目概述

### 1.1 产品名称
Code Wiki - AI驱动的代码文档生成与浏览工具

### 1.2 产品简介
Code Wiki 是一个全栈 Web 应用，利用 AI 为代码库自动生成结构化的 Markdown 文档，并提供现代化的交互界面来浏览代码及生成的 Wiki。该产品旨在帮助开发者快速理解和维护代码库，提高代码可读性和团队协作效率。

### 1.3 产品愿景
成为开发者首选的代码文档自动化工具，通过 AI 技术降低代码理解和维护成本，提升软件开发效率。

## 2. 产品背景与目标

### 2.1 问题定义
- 代码文档缺失或过时，导致新人上手困难
- 代码理解成本高，影响开发效率
- 手动编写文档耗时费力，难以维护
- 代码结构复杂，缺乏直观的可视化展示

### 2.2 目标用户
- 软件开发团队
- 项目经理和技术负责人
- 需要理解他人代码的开发者
- 技术文档编写人员

### 2.3 产品目标
- 自动化生成高质量的代码文档
- 提供直观的代码浏览和理解界面
- 支持多种编程语言的代码分析
- 实现高效的团队协作和知识共享

## 3. 核心功能

### 3.1 代码上传与管理
- **文件/文件夹上传**: 支持单文件和文件夹批量上传
- **项目管理**: 支持多项目管理，通过URL快速切换
- **文件浏览**: 类似VSCode的文件树结构，支持文件搜索和过滤
- **文件操作**: 支持文件删除、重命名等基本操作

### 3.2 AI驱动的文档生成
- **单文件生成**: 为单个文件生成详细的技术文档
- **批量生成**: 支持整个项目批量生成文档
- **智能分析**: 使用AI代理深度分析代码逻辑和依赖关系
- **可视化图表**: 自动生成Mermaid流程图和架构图
- **缓存机制**: 生成的文档自动缓存，避免重复生成

### 3.3 文档浏览与对比
- **并排视图**: 左右分栏同时查看原始代码与AI生成的Wiki
- **代码高亮**: 支持多种编程语言的语法高亮
- **链接导航**: 文档中自动创建代码间的链接，便于跳转
- **搜索功能**: 支持在文档中搜索关键词

### 3.4 AI聊天助手
- **代码解释**: 基于代码上下文提供智能问答
- **修改建议**: 提供代码优化和重构建议
- **实时交互**: 支持与AI代理的实时对话
- **上下文感知**: 理解当前项目和选中文件的上下文

### 3.5 任务管理
- **批量任务**: 支持后台批量处理文档生成任务
- **进度跟踪**: 实时显示任务进度和状态
- **错误处理**: 自动处理生成过程中的错误和异常
- **中断恢复**: 支持任务中断后的恢复功能

### 3.6 用户体验
- **现代化界面**: 基于Next.js 16构建的现代化Web界面
- **响应式设计**: 支持桌面和移动端访问
- **主题切换**: 支持深色/浅色主题切换
- **国际化**: 支持多语言界面（目前主要支持日语和英语）

## 4. 技术架构

### 4.1 整体架构
Code Wiki 采用前后端分离的微服务架构：

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Frontend      │    │   Backend        │    │     AI/LLM      │
│   (Next.js)     │◄──►│   (FastAPI)      │◄──►│   (Ollama/     │
│                 │    │                  │    │   OpenAI)       │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### 4.2 前端技术栈
- **框架**: Next.js 16.1.0 + React 19.2.3
- **运行时**: Turbopack (开发) / Node.js (生产)
- **状态管理**: React Hooks + Context API
- **UI组件**: Tailwind CSS 4 + shadcn/ui
- **代码编辑器**: Monaco Editor
- **国际化**: react-i18next
- **包管理**: Bun
- **测试**: Vitest + React Testing Library

### 4.3 后端技术栈
- **框架**: FastAPI (Python 3.12+)
- **数据库**: SQLite (任务管理) + 文件系统 (文档缓存)
- **AI框架**: LangChain 1.2.x + LangGraph 1.0.5
- **AI代理**: 基于LangGraph的状态机
- **依赖管理**: uv (Python包管理器)
- **测试**: pytest

### 4.4 AI集成
- **代理系统**: 基于LangGraph的AI代理
- **模型支持**: Ollama (本地) / OpenAI (云端)
- **工具集成**: 自定义工具用于代码读取和分析
- **对话能力**: 通过CopilotKit集成智能对话

## 5. 详细功能规格

### 5.1 项目管理功能
#### 5.1.1 项目创建与切换
- 通过URL参数实现项目切换
- 支持项目列表管理和快速访问
- 项目配置独立存储

#### 5.1.2 文件管理
- 支持拖拽上传文件和文件夹
- 文件树展示，支持折叠/展开
- 文件搜索和过滤功能
- 文件删除和重命名操作

### 5.2 文档生成功能
#### 5.2.1 单文件生成
- 选择文件后点击生成按钮
- 实时显示生成进度
- 生成完成后自动显示文档内容
- 支持强制重新生成

#### 5.2.2 批量生成
- 一键启动整个项目的文档生成
- 并发处理多个文件（默认最大3个并发）
- 实时进度条显示
- 错误文件统计和重试机制

#### 5.2.3 文档缓存
- 生成的文档自动保存到本地文件系统
- 缓存命中检查，避免重复生成
- 支持缓存清理和更新
- 文件变更检测机制

### 5.3 文档浏览功能
#### 5.3.1 并排视图
- 左侧显示原始代码，右侧显示生成的文档
- 代码和文档同步滚动
- 支持单侧视图切换
- 响应式布局适配

#### 5.3.2 文档渲染
- Markdown内容渲染
- 代码语法高亮
- Mermaid图表渲染
- 数学公式支持

#### 5.3.3 导航功能
- 文件树快速导航
- 文档内锚点跳转
- 历史记录管理
- 书签功能

### 5.4 AI对话功能
#### 5.4.1 代码问答
- 基于当前文件的上下文问答
- 支持跨文件的知识检索
- 自然语言解释代码逻辑
- 提供建议和最佳实践

#### 5.4.2 代码分析
- 识别代码结构和依赖关系
- 检测潜在问题和优化点
- 生成重构建议
- 性能分析报告

## 6. 用户界面设计

### 6.1 整体布局
- **左侧边栏**: 文件树、搜索、上传按钮
- **主内容区**: 代码和文档并排显示
- **底部区域**: AI对话界面
- **顶部导航**: 项目切换、用户信息、设置

### 6.2 响应式设计
- 桌面端: 三栏布局（侧边栏+主内容+对话）
- 平板端: 双栏布局，对话区域可折叠
- 移动端: 单栏布局，标签页切换

### 6.3 交互设计
- 拖拽上传支持
- 文件树右键菜单
- 快捷键支持
- 悬停效果和过渡动画

## 7. 数据模型

### 7.1 项目数据模型
```python
class Project:
    name: str
    path: str
    created_at: datetime
    updated_at: datetime
```

### 7.2 文件数据模型
```python
class File:
    path: str
    project_name: str
    size: int
    modified_at: datetime
    is_cached: bool
```

### 7.3 任务数据模型
```python
class BatchTask:
    project_name: str
    total_files: int
    completed_files: int
    failed_files: int
    status: str
    start_time: datetime
    end_time: datetime
    errors: List[dict]
```

## 8. API接口设计

### 8.1 文件管理API
- `GET /api/v1/projects/{project_name}/files` - 获取项目文件列表
- `POST /api/v1/projects/{project_name}/upload` - 上传文件
- `DELETE /api/v1/projects/{project_name}/files` - 删除文件

### 8.2 文档生成API
- `GET /api/v1/projects/{project_name}/wiki?file_path={file_path}` - 获取文档内容
- `POST /api/v1/projects/{project_name}/wiki` - 生成文档（SSE流）
- `PUT /api/v1/projects/{project_name}/wiki` - 更新文档内容

### 8.3 任务管理API
- `POST /api/v1/projects/{project_name}/batch-task` - 创建批量任务
- `GET /api/v1/projects/{project_name}/batch-task` - 获取任务状态
- `DELETE /api/v1/projects/{project_name}/batch-task` - 取消任务

## 9. 安全与认证

### 9.1 用户认证
- JWT Token认证机制
- 基于角色的访问控制
- 会话管理
- 登出功能

### 9.2 数据安全
- 文件路径安全验证，防止路径遍历攻击
- 上传文件类型和大小限制
- 敏感信息加密存储
- API访问频率限制

## 10. 性能优化

### 10.1 前端优化
- 代码分割和懒加载
- 图片和资源优化
- 缓存策略
- 预加载关键资源

### 10.2 后端优化
- 异步处理大量文件
- 数据库查询优化
- 缓存策略
- 并发控制

### 10.3 AI性能
- 模型推理优化
- 请求合并和批处理
- 结果缓存
- 资源限制管理

## 11. 部署与运维

### 11.1 部署方案
- Docker容器化部署
- 前后端分离部署
- 环境变量管理
- 数据持久化

### 11.2 监控与日志
- 应用性能监控
- 错误日志收集
- 任务执行监控
- 系统资源监控

### 11.3 备份与恢复
- 文档缓存备份
- 任务状态备份
- 配置文件备份
- 灾难恢复计划

## 12. 测试策略

### 12.1 单元测试
- 后端API单元测试 (pytest)
- 前端组件单元测试 (Vitest)
- AI代理逻辑测试
- 工具函数测试

### 12.2 集成测试
- 前后端集成测试
- AI生成流程测试
- 文件上传下载测试
- 任务管理测试

### 12.3 端到端测试
- 用户操作流程测试
- 文档生成端到端测试
- AI对话功能测试
- 性能压力测试

## 13. 未来发展规划

### 13.1 短期规划 (3-6个月)
- 支持更多编程语言
- 增强代码分析能力
- 改进文档模板
- 优化AI生成质量

### 13.2 中期规划 (6-12个月)
- 团队协作功能
- 版本控制集成
- 文档导出功能
- 移动端应用

### 13.3 长期规划 (1年以上)
- 企业级功能
- 插件生态系统
- 高级分析报告
- 云原生部署

## 14. 风险评估

### 14.1 技术风险
- AI模型准确性不足
- 大文件处理性能问题
- 并发访问压力
- 数据一致性问题

### 14.2 业务风险
- 用户接受度不高
- 竞争对手压力
- 成本控制挑战
- 法律合规风险

### 14.3 应对措施
- 持续优化AI模型
- 实施性能监控
- 建立用户反馈机制
- 遵守数据保护法规

---

## 附录

### A. 技术依赖版本
- **后端**: Python 3.12+, FastAPI 0.115.x, LangGraph 1.0.5
- **前端**: Next.js 16.1.0, React 19.2.3, TypeScript
- **AI**: LangChain 1.2.x, CopilotKit 0.1.74
- **工具**: uv (Python), Bun (前端)

### B. 环境配置
- **开发环境**: 本地运行，前后端分别启动
- **生产环境**: Docker容器化部署
- **AI模型**: 支持Ollama本地部署或OpenAI云端服务

### C. 开发规范
- 代码风格遵循项目约定
- 提交信息遵循conventional commits
- 重要功能必须有测试覆盖
- 文档与代码同步更新
