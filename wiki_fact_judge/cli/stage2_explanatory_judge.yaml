providers:
  - id: ollama:gpt-oss:120b
    config:
      temperature: 0
      top_p: 1

prompts:
  - |
    You are an EXTREMELY STRICT but FAIR ENGINEERING DOCUMENTATION JUDGE.

    You are evaluating a GENERATED WIKI written for engineers.
    The intended reader is:
    - A developer who just took over this module
    - Has basic language/framework knowledge
    - Does NOT know this codebase yet

    Your task is NOT to judge writing style.
    Your task is to judge ENGINEERING VALUE, EXPLANATORY SOUNDNESS,
    and ENGINEERING RISK.

    ============================================================
    INPUT
    ============================================================

    - STRUCTURAL COVERAGE RESULTS (from Stage 1)
    - EXPLANATION ALIGNMENT RESULTS (from Stage 1.5)
    - GENERATED WIKI
    - ARTIFACT TYPE
    - SOURCE CODE (reference only)

    IMPORTANT:
    - Stage 1 and Stage 1.5 results are PRE-ESTABLISHED FACTS.
    - You MUST NOT contradict or override their conclusions.
    - Your role is to ASSESS ENGINEERING QUALITY based on these facts.

    [STRUCTURAL COVERAGE RESULTS]
    {{structural_coverage_results}}

    [EXPLANATION ALIGNMENT RESULTS]
    {{explanation_alignment_results}}

    [GENERATED WIKI]
    {{wiki_md}}

    [ARTIFACT TYPE]
    {{artifact_type}}

    [SOURCE CODE]
    {{source_code}}

    ------------------------------------------------------------
    CORE EVALUATION PRINCIPLES (MANDATORY)
    ------------------------------------------------------------

    1. Judge strictly from the perspective of a NEW MAINTAINER.
       Ask yourself:
       - "Do I understand what this file ACTUALLY does?"
       - "Do I know where I could easily break things if I modify it?"

    2. Favor ENGINEERING-RELEVANT explanations.
       - Explaining why something exists is valuable.
       - But explanations MUST be defensible from the source code.

    3. Penalize FABRICATION and OVER-INTERPRETATION heavily.
       - Any invented responsibility, behavior, or guarantee
         is a serious engineering risk.

    4. Do NOT use extreme judgments unless forced by rules.
       - Partial usefulness is allowed.
       - Risk-aware scoring will be applied later.

    ------------------------------------------------------------
    EVALUATION DIMENSIONS
    ------------------------------------------------------------

    You MUST evaluate the wiki along ALL dimensions below.
    Use ONLY the allowed labels.

    ------------------------------------------------------------
    1. comprehension_support
    ------------------------------------------------------------

    Question:
    Does this wiki help a new developer build a correct mental model
    of what this file/module does and why it exists?

    Allowed values:
    - HIGH: Clear purpose, clear role, confusion points addressed
    - MEDIUM: General idea is understandable, some context missing
    - LOW: Only surface behavior or code structure is visible

    ------------------------------------------------------------
    2. engineering_usefulness
    ------------------------------------------------------------

    Question:
    Would this wiki help with real engineering work
    (debugging, modification, code review)?

    Allowed values:
    - HIGH: Actively supports safe modification and reasoning
    - MEDIUM: Useful for understanding, limited for changes
    - LOW: Informational only

    ------------------------------------------------------------
    3. explanation_reasonableness
    ------------------------------------------------------------

    Question:
    Are the explanations careful, defensible, and proportional?

    Allowed values:
    - HIGH: Careful, grounded, appropriately scoped
    - MEDIUM: Mostly reasonable, minor overreach
    - LOW: Unsupported assumptions or asserted intent

    ------------------------------------------------------------
    4. abstraction_quality
    ------------------------------------------------------------

    Question:
    Is the abstraction level appropriate for a technical wiki?

    Allowed values:
    - GOOD: Abstraction clearly improves understanding
    - OK: Some abstraction issues, but usable
    - POOR: Either code paraphrase or hand-wavy architecture talk

    ------------------------------------------------------------
    5. fabrication_risk
    ------------------------------------------------------------

    This value MUST be CONSISTENT with Stage 1.5.

    Allowed values:
    - LOW: All explanations traceable to code
    - MEDIUM: Some cautious inference, not misleading
    - HIGH: Invented behavior, roles, or guarantees

    ============================================================
    CRITICAL FABRICATION RULES (HARD CONSTRAINTS)
    ============================================================

    You MUST explicitly classify fabrication_type.

    ------------------------------------------------------------
    A. ARCHITECTURAL FABRICATION (HARDEST RULE)
    ------------------------------------------------------------

    If the wiki introduces ANY architectural layers, system roles,
    module responsibilities, execution flows, or interactions
    that are NOT explicitly present in the source code:

    You MUST output:
    - explanation_reasonableness = LOW
    - fabrication_risk = HIGH
    - fabrication_type = ARCHITECTURAL

    This applies EVEN IF the explanation sounds reasonable
    or follows common industry patterns.

    ------------------------------------------------------------
    B. LOCAL FABRICATION
    ------------------------------------------------------------

    Use this if:
    - The overall architecture is correct
    - BUT specific methods, fields, conditions, flags, or SQL clauses
      are incorrectly explained

    Output:
    - fabrication_type = LOCAL

    ------------------------------------------------------------
    C. TERMINOLOGY FABRICATION
    ------------------------------------------------------------

    Use this if:
    - The wiki introduces domain terms, technical concepts,
      named patterns, or guarantees NOT present in code or comments
    - The terminology implies behavior not supported by code

    Output:
    - fabrication_type = TERMINOLOGY

    ------------------------------------------------------------
    D. NO FABRICATION
    ------------------------------------------------------------

    If none of the above apply:
    - fabrication_type = NONE

    ------------------------------------------------------------
    ABSTRACTION MISMATCH (IMPORTANT)
    ------------------------------------------------------------

    If the explanation is factually correct BUT the abstraction level
    does NOT directly support safe debugging or modification:

    - abstraction_quality MUST be OK or POOR

    ============================================================
    CRITICAL FACT ERROR (MANDATORY FLAG)
    ============================================================

    If the wiki contains ANY factually incorrect statement that would
    directly mislead debugging, modification, or production handling,
    you MUST output:

    - critical_fact_error = true

    Examples include (but are not limited to):
    - Claiming a method is called when it is not
    - Claiming a getter/setter transforms data when it does not
    - Misstating the meaning of a SQL condition or flag
    - Omitting or misrepresenting a field that affects behavior

    If no such errors exist:
    - critical_fact_error = false

    ============================================================
    OUTPUT FORMAT (STRICT)
    ============================================================

    You MUST output a SINGLE JSON object.
    DO NOT include markdown.
    DO NOT include explanations outside the JSON.

    Required keys:

    {
      "comprehension_support": "HIGH | MEDIUM | LOW",
      "engineering_usefulness": "HIGH | MEDIUM | LOW",
      "explanation_reasonableness": "HIGH | MEDIUM | LOW",
      "abstraction_quality": "GOOD | OK | POOR",
      "fabrication_risk": "LOW | MEDIUM | HIGH",
      "fabrication_type": "NONE | ARCHITECTURAL | LOCAL | TERMINOLOGY",
      "critical_fact_error": true | false,
      "summary": "Concise, factual explanation of strengths, weaknesses, and risks"
    }

    The summary MUST:
    - Be factual and engineer-facing
    - Avoid emotional or judgmental language
    - Help a human quickly understand why these ratings were chosen

tests:
  - name: Stage2 Engineering Judge v3.1
    assert:
      - type: contains-json
