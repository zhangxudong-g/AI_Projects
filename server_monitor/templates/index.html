<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remote Server Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body.dark-theme {
            background-color: #121212;
            color: #ffffff;
        }

        .server-card {
            margin-bottom: 20px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: 1px solid rgba(0, 0, 0, 0.125);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        body.dark-theme .server-card {
            background-color: #1e1e1e;
            border-color: #333;
            color: #ffffff;
        }

        .metric-card {
            margin-bottom: 15px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            transition: background-color 0.3s ease;
        }

        body.dark-theme .metric-card {
            background-color: #2d2d2d;
            color: #ffffff;
        }

        .progress-container {
            margin-top: 10px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-running {
            background-color: #28a745;
        }

        .status-stopped {
            background-color: #dc3545;
        }

        .gpu-card {
            background-color: #e8f4fd;
        }

        body.dark-theme .gpu-card {
            background-color: #1a232a;
        }

        .cpu-card {
            background-color: #f0f8e8;
        }

        body.dark-theme .cpu-card {
            background-color: #232a1a;
        }

        .memory-card {
            background-color: #fdf0e8;
        }

        body.dark-theme .memory-card {
            background-color: #2a231a;
        }

        .ollama-card {
            background-color: #f8e8fd;
        }

        body.dark-theme .ollama-card {
            background-color: #2a1a23;
        }

        .refresh-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 0.8em;
            color: #6c757d;
        }

        body.dark-theme .refresh-indicator {
            color: #aaa;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
            overflow: hidden;
        }

        .chart-container canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* 响应式图表设计 */
        @media (max-width: 768px) {
            .chart-container {
                height: 200px;
                margin-top: 10px;
            }

            .row.mt-4 {
                margin-top: 1rem !important;
            }
        }

        @media (max-width: 576px) {
            .chart-container {
                height: 150px;
            }

            .col-md-6.col-sm-12 {
                flex: 0 0 100%;
                max-width: 100%;
            }
        }

        /* 修复Chart.js的响应式问题 */
        .chartjs-size-monitor,
        .chartjs-size-monitor-expand,
        .chartjs-size-monitor-shrink {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            pointer-events: none;
            z-index: -1;
            visibility: hidden;
        }

        .chartjs-size-monitor-expand>div {
            position: absolute;
            width: 1000000px;
            height: 1000000px;
            left: 0;
            top: 0;
        }

        .chartjs-size-monitor-shrink>div {
            position: absolute;
            width: 200%;
            height: 200%;
            left: 0;
            top: 0;
        }

        /* 确保图表容器正确显示 */
        .chart-container {
            position: relative;
            width: 100%;
        }

        .chart-container canvas {
            width: 100% !important;
            height: 100% !important;
            max-width: 100%;
            max-height: 100%;
        }

        /* GPU图表容器样式 */
        .gpu-chart-container {
            background-color: rgba(54, 162, 235, 0.05);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid rgba(54, 162, 235, 0.2);
        }

        .gpu-chart-header {
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(54, 162, 235, 0.2);
        }

        .gpu-chart-header h6 {
            color: #3399ff;
            font-weight: 500;
        }

        body.dark-theme .gpu-chart-container {
            background-color: rgba(54, 162, 235, 0.1);
            border: 1px solid rgba(54, 162, 235, 0.3);
        }

        body.dark-theme .gpu-chart-header {
            border-bottom: 1px solid rgba(54, 162, 235, 0.3);
        }

        body.dark-theme .card-header {
            background-color: #333;
            color: #fff;
            border-color: #444;
        }

        body.dark-theme .progress {
            background-color: #444;
        }

        body.dark-theme .progress-bar {
            background-color: #0d6efd;
        }

        body.dark-theme .table {
            color: #fff;
        }

        body.dark-theme .table th,
        body.dark-theme .table td {
            border-color: #444;
        }

        body.dark-theme .bg-light {
            background-color: #2d2d2d !important;
        }

        body.dark-theme .text-muted {
            color: #aaa !important;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .container-fluid {
                padding-left: 10px;
                padding-right: 10px;
            }

            .col-md-4 {
                flex: 0 0 100%;
                max-width: 100%;
            }

            .col-lg-6 {
                flex: 0 0 100%;
                max-width: 100%;
            }

            .col-md-6 {
                flex: 0 0 100%;
                max-width: 100%;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .card-header h5 {
                margin-bottom: 10px;
            }

            .chart-container {
                height: 200px;
            }

            .metric-card {
                padding: 10px;
            }

            .progress {
                height: 15px;
            }

            .btn-sm {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }
        }

        @media (max-width: 576px) {
            body {
                padding-top: 10px;
            }

            h4 {
                font-size: 1.2rem;
            }

            .card-body {
                padding: 0.75rem;
            }

            .chart-container {
                height: 150px;
            }

            .small,
            small {
                font-size: 0.8rem;
            }

            .metric-card h6,
            .metric-card h7 {
                font-size: 0.9rem;
            }
        }

        @media (min-width: 992px) {
            .container-fluid {
                max-width: 95%;
            }
        }

        /* 触摸优化 */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
            padding: 10px;
        }

        /* 移动端滚动优化 */
        body {
            -webkit-overflow-scrolling: touch;
        }

        /* 优化移动端字体大小 */
        @media (max-width: 768px) {
            .metric-card {
                font-size: 0.9rem;
            }

            .progress {
                font-size: 0.75rem;
            }

            .card-header h5 {
                font-size: 1.1rem;
            }
        }

        /* 优化表格在移动端的显示 */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* 优化卡片在移动端的间距 */
        @media (max-width: 576px) {
            .metric-card {
                margin-bottom: 10px;
                padding: 10px;
            }

            .server-card {
                margin-bottom: 15px;
            }
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="text-center mb-0">Remote Server Monitor</h4>
            <div class="d-flex gap-2">
                <button id="dockerBtn" class="btn btn-outline-info btn-sm" data-bs-toggle="modal"
                    data-bs-target="#dockerModal">
                    <i class="fas fa-docker"></i> Docker Status
                </button>
                <button id="cliBtn" class="btn btn-outline-warning btn-sm" data-bs-toggle="modal"
                    data-bs-target="#cliModal">
                    <i class="fas fa-terminal"></i> CLI
                </button>
                <div class="d-md-none">
                    <button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse"
                        data-bs-target="#mobileMenu" aria-expanded="false">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="collapse" id="mobileMenu">
            <div class="card card-body mb-3">
                <div class="d-grid gap-2">
                    <button id="customizeBtnMobile" class="btn btn-outline-secondary" data-bs-toggle="modal"
                        data-bs-target="#customizeModal">
                        <i class="fas fa-cog me-1"></i> Customize Dashboard
                    </button>
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-12">
                <div class="card server-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">All Servers Overview</h5>
                        <div class="d-flex align-items-center">
                            <span id="last-update-all" class="text-muted me-2">Last update: --:--:--</span>
                            <button id="customizeBtn" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal"
                                data-bs-target="#customizeModal">
                                <i class="fas fa-cog"></i> Customize
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-4">
                                <div id="all-servers-data" class="row">
                                    <!-- 动态内容将在这里插入 -->
                                </div>
                            </div>
                            <div class="col-lg-8">
                                <div class="gpu-chart-container">
                                    <div class="gpu-chart-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">GPU Usage</h6>
                                        <button id="gpuHistoryBtn" class="btn btn-sm btn-outline-info" data-bs-toggle="modal" data-bs-target="#gpuHistoryModal">
                                            <i class="fas fa-history"></i> Peak History
                                        </button>
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="gpuOverviewChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 定制模态框 -->
        <div class="modal fade" id="customizeModal" tabindex="-1" aria-labelledby="customizeModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="customizeModalLabel">Dashboard Customization</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Select Components to Show:</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showCpu" checked>
                                <label class="form-check-label" for="showCpu">CPU Usage</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showMemory" checked>
                                <label class="form-check-label" for="showMemory">Memory Usage</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showGpu" checked>
                                <label class="form-check-label" for="showGpu">GPU Usage</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showDisk" checked>
                                <label class="form-check-label" for="showDisk">Disk Usage</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showNetwork" checked>
                                <label class="form-check-label" for="showNetwork">Network Usage</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showTemp" checked>
                                <label class="form-check-label" for="showTemp">Temperature</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showCustomCmd" checked>
                                <label class="form-check-label" for="showCustomCmd">Custom Commands</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="showCharts" checked>
                                <label class="form-check-label" for="showCharts">Charts Visualization</label>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Refresh Interval (seconds):</label>
                            <input type="number" class="form-control" id="refreshInterval" min="1" max="60" value="1">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Theme:</label>
                            <select class="form-select" id="themeSelector">
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="applyCustomization">Apply</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="server-details">
            <!-- 服务器详情将动态生成 -->
        </div>

        <!-- 图表可视化区域 -->
        <div class="row mt-4" id="chartsContainer">
            <div class="col-md-12">
                <div class="card server-card">
                    <div class="card-header">
                        <h5 class="mb-0">Real-time Charts</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 col-sm-12">
                                <div class="chart-container">
                                    <canvas id="cpuChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6 col-sm-12">
                                <div class="chart-container">
                                    <canvas id="memoryChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-md-6 col-sm-12">
                                <div class="chart-container">
                                    <canvas id="diskChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6 col-sm-12">
                                <div class="chart-container">
                                    <canvas id="gpuChart" style="display: none;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 服务器列表将在页面加载时从API获取
        let servers = [];
        let wsConnections = {};
        let allWsConnection = null;
        let serverDataCache = {}; // 缓存服务器数据以减少闪烁
        let lastUpdateTime = {}; // 记录上次更新时间，防止过于频繁的更新
        let cachedServerList = null; // 缓存服务器列表，避免重复API调用

        // 初始化WebSocket连接
        function initWebSocket() {
            // 获取存储的令牌
            const token = localStorage.getItem('access_token');
            const authHeader = token ? `Bearer ${token}` : '';

            // 连接到所有服务器数据的WebSocket
            allWsConnection = new WebSocket(`ws://${window.location.host}/ws-all`);

            // 监听来自服务器的消息
            allWsConnection.onmessage = function (event) {
                let data;

                // 检查是否是二进制数据（压缩数据）
                if (event.data instanceof Blob) {
                    // 处理压缩数据
                    const reader = new FileReader();
                    reader.onload = function () {
                        try {
                            // 使用pako库解压gzip数据
                            const compressedArray = new Uint8Array(reader.result);
                            const decompressedArray = pako.ungzip(compressedArray);
                            const text = new TextDecoder().decode(decompressedArray);
                            data = JSON.parse(text);

                            // 更新缓存
                            for (const serverName in data) {
                                if (data[serverName] && !data[serverName].error) {
                                    serverDataCache[serverName] = data[serverName];
                                }
                            }

                            updateAllServersView(data);
                            updateCharts(data); // 更新图表
                        } catch (e) {
                            console.error('Error decompressing data:', e);
                        }
                    };
                    reader.readAsArrayBuffer(event.data);
                } else {
                    // 处理普通JSON数据
                    data = JSON.parse(event.data);

                    // 更新缓存
                    for (const serverName in data) {
                        if (data[serverName] && !data[serverName].error) {
                            serverDataCache[serverName] = data[serverName];
                        }
                    }

                    updateAllServersView(data);
                    updateCharts(data); // 更新图表
                }
            };

            allWsConnection.onerror = function (error) {
                console.error('WebSocket error:', error);
            };

            allWsConnection.onclose = function () {
                console.log('All servers WebSocket closed, checking if reconnect is needed...');
                // 检查是否有令牌，如果没有则不重连
                const token = localStorage.getItem('access_token');
                if (!token) {
                    // 如果没有令牌，不重连
                    return;
                }
                setTimeout(initWebSocket, 5000);
            };

            // 为每个服务器创建单独的WebSocket连接
            servers.forEach(server => {
                const ws = new WebSocket(`ws://${window.location.host}/ws/${server}`);
                wsConnections[server] = ws;

                // WebSocket连接打开后无需认证

                ws.onmessage = function (event) {
                    let data;

                    // 检查是否是二进制数据（压缩数据）
                    if (event.data instanceof Blob) {
                        // 处理压缩数据
                        const reader = new FileReader();
                        reader.onload = function () {
                            try {
                                // 使用pako库解压gzip数据
                                const compressedArray = new Uint8Array(reader.result);
                                const decompressedArray = pako.ungzip(compressedArray);
                                const text = new TextDecoder().decode(decompressedArray);
                                data = JSON.parse(text);

                                // 更新缓存
                                if (data && !data.error) {
                                    serverDataCache[data.server_name] = data;

                                    // 防止过于频繁的更新，减少闪烁
                                    const now = Date.now();
                                    const serverKey = data.server_name || server;
                                    // 使用定制的刷新间隔来控制更新频率
                                    if (!lastUpdateTime[serverKey] || now - lastUpdateTime[serverKey] > dashboardSettings.refreshInterval) {
                                        lastUpdateTime[serverKey] = now;
                                        updateSingleServerView(server, data);
                                    }
                                }
                            } catch (e) {
                                console.error('Error decompressing data:', e);
                            }
                        };
                        reader.readAsArrayBuffer(event.data);
                    } else {
                        // 处理普通JSON数据
                        data = JSON.parse(event.data);

                        // 更新缓存
                        if (data && !data.error) {
                            serverDataCache[data.server_name] = data;

                            // 防止过于频繁的更新，减少闪烁
                            const now = Date.now();
                            const serverKey = data.server_name || server;
                            // 使用定制的刷新间隔来控制更新频率
                            if (!lastUpdateTime[serverKey] || now - lastUpdateTime[serverKey] > dashboardSettings.refreshInterval) {
                                lastUpdateTime[serverKey] = now;
                                updateSingleServerView(server, data);
                            }
                        }
                    }
                };

                ws.onerror = function (error) {
                    console.error(`WebSocket error for ${server}:`, error);
                };

                ws.onclose = function () {
                    console.log(`WebSocket for ${server} closed, checking if reconnect is needed...`);
                    // 检查是否有令牌，如果没有则不重连
                    const token = localStorage.getItem('access_token');
                    if (!token) {
                        // 如果没有令牌，不重连
                        return;
                    }
                    setTimeout(() => initServerWebSocket(server), 5000);
                };
            });
        }

        function initServerWebSocket(server) {
            const ws = new WebSocket(`ws://${window.location.host}/ws/${server}`);
            wsConnections[server] = ws;

            ws.onmessage = function (event) {
                const data = JSON.parse(event.data);
                updateSingleServerView(server, data);
            };

            ws.onerror = function (error) {
                console.error(`WebSocket error for ${server}:`, error);
            };

            ws.onclose = function () {
                console.log(`WebSocket for ${server} closed, checking if reconnect is needed...`);
                // 检查是否有令牌，如果没有则不重连
                const token = localStorage.getItem('access_token');
                if (!token) {
                    // 如果没有令牌，不重连
                    return;
                }
                setTimeout(() => initServerWebSocket(server), 5000);
            };
        }

        // 更新所有服务器视图
        function updateAllServersView(data) {
            const container = document.getElementById('all-servers-data');
            const timestamp = new Date().toLocaleTimeString();
            document.getElementById('last-update-all').textContent = `Last update: ${timestamp}`;

            let html = '';

            for (const serverName in data) {
                const serverData = data[serverName];

                if (serverData.error) {
                    html += `
                    <div>
                        <div class="metric-card">
                            <h6>${serverName} <span class="badge bg-danger">Error</span></h6>
                            <p class="text-danger">${serverData.error}</p>
                        </div>
                    </div>`;
                    continue;
                }

                // 获取GPU使用率平均值
                let avgGpuUtil = 0;
                if (serverData.gpu_info && serverData.gpu_info.length > 0) {
                    const totalUtil = serverData.gpu_info.reduce((sum, gpu) => sum + gpu.utilization, 0);
                    avgGpuUtil = Math.round(totalUtil / serverData.gpu_info.length);
                }

                // 获取CPU使用率
                const cpuPercent = serverData.system_resources ? serverData.system_resources.cpu_percent : 0;

                // 获取内存使用率
                let memoryPercent = 0;
                if (serverData.system_resources) {
                    const { memory_used, memory_total } = serverData.system_resources;
                    if (memory_total > 0) {
                        memoryPercent = Math.round((memory_used / memory_total) * 100);
                    }
                }

                html += `
                <div>
                    <div class="metric-card">
                        <h6>${serverName}</h6>
                        <div class="row">
                            ${dashboardSettings.showCpu ? `
                            <div class="col-6">
                                <small>CPU</small>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar"
                                        style="width: ${Math.min(cpuPercent, 100)}%"
                                        aria-valuenow="${Math.min(cpuPercent, 100)}"
                                        aria-valuemin="0" aria-valuemax="100">
                                        ${Math.min(cpuPercent, 100)}%
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            ${dashboardSettings.showMemory ? `
                            <div class="col-6">
                                <small>Memory</small>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar"
                                        style="width: ${Math.min(memoryPercent, 100)}%"
                                        aria-valuenow="${Math.min(memoryPercent, 100)}"
                                        aria-valuemin="0" aria-valuemax="100">
                                        ${Math.min(memoryPercent, 100)}%
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        <div class="row mt-2">
                            ${dashboardSettings.showGpu ? `
                            <div class="col-6">
                                <small>GPU Avg</small>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar"
                                        style="width: ${Math.min(avgGpuUtil, 100)}%"
                                        aria-valuenow="${Math.min(avgGpuUtil, 100)}"
                                        aria-valuemin="0" aria-valuemax="100">
                                        ${Math.min(avgGpuUtil, 100)}%
                                    </div>
                                </div>
                            </div>
                            ` : ''}

                            ${dashboardSettings.showGpu && serverData.gpu_info && serverData.gpu_info.length > 0 ? `
                            <div class="col-6">
                                <small>GPU Detail</small>
                                <div class="small">
                                    ${serverData.gpu_info.slice(0, 2).map(gpu => `
                                        <div>
                                            <div class="d-flex justify-content-between">
                                                <span>GPU${gpu.index}</span>
                                                <span>${gpu.utilization}%</span>
                                            </div>
                                            <div class="progress" style="height: 5px;">
                                                <div class="progress-bar" role="progressbar"
                                                    style="width: ${gpu.utilization}%"
                                                    aria-valuenow="${gpu.utilization}"
                                                    aria-valuemin="0" aria-valuemax="100">
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                    ${serverData.gpu_info.length > 2 ?
                            `<div class="text-center">+${serverData.gpu_info.length - 2} more</div>` : ''}
                                </div>
                            </div>
                            ` :
                        `${dashboardSettings.showGpu ? `
                            <div class="col-6">
                                <small>GPU Detail</small>
                                <div class="text-muted">No GPU</div>
                            </div>
                            ` : ''}`}
                            <div class="col-6">
                                <small>Models</small>
                                ${serverData.ollama_models && serverData.ollama_models.length > 0 ?
                        `<div>
                                    <p class="mb-0">${serverData.ollama_models.length} running</p>
                                    <small class="text-muted">${serverData.ollama_models.slice(0, 2).map(m => m.name).join(', ')}</small>
                                    ${serverData.ollama_models.length > 2 ? `<br><small class="text-muted">+${serverData.ollama_models.length - 2} more</small>` : ''}
                                  </div>` :
                        '<p class="mb-0">0</p>'
                    }
                            </div>
                        </div>
                        ${dashboardSettings.showDisk ? `
                        <div class="row mt-2">
                            <div class="col-12">
                                <small>Disk Usage</small>
                                ${serverData.system_resources.disk_info && serverData.system_resources.disk_info.length > 0 ?
                            serverData.system_resources.disk_info.slice(0, 2).map(disk => `
                                    <div class="progress mt-1">
                                        <div class="progress-bar" role="progressbar"
                                            style="width: ${disk.percent}%"
                                            title="${disk.mount_point}: ${disk.percent}% used"
                                            aria-valuenow="${disk.percent}"
                                            aria-valuemin="0" aria-valuemax="100">
                                            ${disk.mount_point}:${disk.percent}%
                                        </div>
                                    </div>
                                  `).join('') :
                            '<div class="progress mt-1"><div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">No disk info</div></div>'
                        }
                            </div>
                        </div>
                        ` : ''}
                        ${dashboardSettings.showNetwork ? `
                        <div class="row mt-2">
                            <div class="col-12">
                                <small>Network (Top Interface)</small>
                                ${serverData.system_resources.network_info && serverData.system_resources.network_info.length > 0 ?
                            `<div class="progress mt-1">
                                      <div class="progress-bar" role="progressbar"
                                          style="width: 50%"
                                          title="${serverData.system_resources.network_info[0].interface}: ${(serverData.system_resources.network_info[0].receive_bytes / (1024 * 1024)).toFixed(2)} MB received"
                                          aria-valuenow="50" aria-valuemin="0" aria-valuemax="100">
                                          ${serverData.system_resources.network_info[0].interface}
                                      </div>
                                   </div>` :
                            '<div class="progress mt-1"><div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">No network info</div></div>'
                        }
                            </div>
                        </div>
                        ` : ''}
                        ${dashboardSettings.showTemp ? `
                        <div class="row mt-2">
                            <div class="col-12">
                                <small>Temperature</small>
                                ${serverData.gpu_info && serverData.gpu_info.length > 0 ?
                            serverData.gpu_info.map(gpu => `
                                    <div class="progress mt-1">
                                        <div class="progress-bar" role="progressbar"
                                            style="width: ${Math.min(gpu.temperature * 2, 100)}%; background-color: ${gpu.temperature > 80 ? '#dc3545' : gpu.temperature > 70 ? '#fd7e14' : '#28a745'};"
                                            title="GPU ${gpu.index}: ${gpu.temperature}°C"
                                            aria-valuenow="${gpu.temperature}"
                                            aria-valuemin="0" aria-valuemax="100">
                                            GPU ${gpu.index}: ${gpu.temperature}°C
                                        </div>
                                     </div>
                                  `).join('') :
                            serverData.system_resources.hardware_temp_info && serverData.system_resources.hardware_temp_info.length > 0 ?
                                `<div class="progress mt-1">
                                        <div class="progress-bar" role="progressbar"
                                            style="width: ${Math.min(Math.max(serverData.system_resources.hardware_temp_info[0].temperature, 0) * 2, 100)}%"
                                            title="${serverData.system_resources.hardware_temp_info[0].sensor_name}: ${serverData.system_resources.hardware_temp_info[0].temperature}${serverData.system_resources.hardware_temp_info[0].unit}"
                                            aria-valuenow="${Math.min(Math.max(serverData.system_resources.hardware_temp_info[0].temperature, 0) * 2, 100)}"
                                            aria-valuemin="0" aria-valuemax="100">
                                            ${serverData.system_resources.hardware_temp_info[0].sensor_name}: ${serverData.system_resources.hardware_temp_info[0].temperature}${serverData.system_resources.hardware_temp_info[0].unit}
                                        </div>
                                     </div>` :
                                '<div class="progress mt-1"><div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">No temp info</div></div>'
                        }
                            </div>
                        </div>
                        ` : ''}
                        ${dashboardSettings.showCustomCmd ? `
                        <div class="row mt-2">
                            <div class="col-12">
                                <small>Custom Commands</small>
                                ${serverData.system_resources.custom_command_results && serverData.system_resources.custom_command_results.length > 0 ?
                            `<div class="progress mt-1">
                                      <div class="progress-bar" role="progressbar"
                                          style="width: ${Math.min(serverData.system_resources.custom_command_results.filter(r => r.success).length / serverData.system_resources.custom_command_results.length * 100, 100)}%"
                                          title="Success rate: ${serverData.system_resources.custom_command_results.filter(r => r.success).length}/${serverData.system_resources.custom_command_results.length}"
                                          aria-valuenow="${Math.min(serverData.system_resources.custom_command_results.filter(r => r.success).length / serverData.system_resources.custom_command_results.length * 100, 100)}"
                                          aria-valuemin="0" aria-valuemax="100">
                                          Success: ${serverData.system_resources.custom_command_results.filter(r => r.success).length}/${serverData.system_resources.custom_command_results.length}
                                      </div>
                                   </div>` :
                            '<div class="progress mt-1"><div class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">No custom commands</div></div>'
                        }
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>`;
            }

            // 只有当内容真正改变时才更新DOM，以减少闪烁
            if (container.innerHTML !== html) {
                container.innerHTML = html;
            }
        }

        // 更新单个服务器视图
        function updateSingleServerView(serverName, data) {
            if (data.error) {
                console.error(`Error from ${serverName}:`, data.error);
                return;
            }

            // 查找或创建服务器详情区域
            // 将服务器名称转换为有效的CSS ID
            const validServerName = serverName.replace(/[^a-zA-Z0-9-_]/g, '-');
            let serverDetail = document.querySelector(`#server-${validServerName}`);
            if (!serverDetail) {
                serverDetail = document.createElement('div');
                serverDetail.id = `server-${validServerName}`;
                serverDetail.className = 'row server-detail';
                document.getElementById('server-details').appendChild(serverDetail);
            }

            // 构建服务器详情HTML
            let html = `
            <div class="col-md-12">
                <div class="card server-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">${data.server_name}</h5>
                        <span class="text-muted">Updated: ${new Date(data.timestamp * 1000).toLocaleTimeString()}</span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- GPU信息 -->
                            <div class="col-lg-6">
                                <div class="metric-card gpu-card">
                                    <h6><i class="fa-solid fa-microchip"></i> GPU Information</h6>
                                    ${data.gpu_info && data.gpu_info.length > 0 ?
                    data.gpu_info.map(gpu => `
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between">
                                                <strong>GPU ${gpu.index}: ${gpu.name}</strong>
                                                <span class="badge ${gpu.temperature > 80 ? 'bg-danger' : gpu.temperature > 70 ? 'bg-warning' : 'bg-success'}">
                                                    ${gpu.temperature}°C
                                                </span>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-6">
                                                    <small>Utilization</small>
                                                    <div class="progress">
                                                        <div class="progress-bar" role="progressbar"
                                                            style="width: ${gpu.utilization}%"
                                                            aria-valuenow="${gpu.utilization}"
                                                            aria-valuemin="0" aria-valuemax="100">
                                                            ${gpu.utilization}%
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <small>Memory</small>
                                                    <div class="progress">
                                                        <div class="progress-bar" role="progressbar"
                                                            style="width: ${gpu.memory_info.total > 0 ? (gpu.memory_info.used / gpu.memory_info.total * 100) : 0}%"
                                                            aria-valuenow="${gpu.memory_info.total > 0 ? (gpu.memory_info.used / gpu.memory_info.total * 100) : 0}"
                                                            aria-valuemin="0" aria-valuemax="100">
                                                            ${gpu.memory_info.used}/${gpu.memory_info.total} MiB
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                      `).join('') :
                    '<p class="text-muted">No GPU detected</p>'
                }
                                </div>

                                <!-- 系统资源信息 -->
                                <div class="metric-card">
                                    <h6>System Resources</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="cpu-card metric-card">
                                                <h7>CPU Usage</h7>
                                                <div class="progress">
                                                    <div class="progress-bar" role="progressbar"
                                                        style="width: ${Math.min(data.system_resources.cpu_percent, 100)}%"
                                                        aria-valuenow="${Math.min(data.system_resources.cpu_percent, 100)}"
                                                        aria-valuemin="0" aria-valuemax="100">
                                                        ${Math.min(data.system_resources.cpu_percent, 100)}%
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="memory-card metric-card">
                                                <h7>Memory Usage</h7>
                                                <div class="progress">
                                                    <div class="progress-bar" role="progressbar"
                                                        style="width: ${(data.system_resources.memory_total > 0 ?
                    Math.round((data.system_resources.memory_used / data.system_resources.memory_total) * 100) : 0)}%"
                                                        aria-valuenow="${(data.system_resources.memory_total > 0 ?
                    Math.round((data.system_resources.memory_used / data.system_resources.memory_total) * 100) : 0)}"
                                                        aria-valuemin="0" aria-valuemax="100">
                                                        ${(data.system_resources.memory_total > 0 ?
                    Math.round((data.system_resources.memory_used / data.system_resources.memory_total) * 100) : 0)}%
                                                    </div>
                                                </div>
                                                <small>${data.system_resources.memory_used.toFixed(2)} / ${data.system_resources.memory_total.toFixed(2)} GB</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Ollama模型信息 -->
                            <div class="col-lg-6">
                                <div class="metric-card ollama-card">
                                    <h6><i class="fa-solid fa-robot"></i> Ollama Models</h6>
                                    ${data.ollama_models && data.ollama_models.length > 0 ?
                    data.ollama_models.map(model => `
                                        <div class="d-flex justify-content-between mb-2">
                                            <div>
                                                <strong>${model.name}</strong><br>
                                                <small class="text-muted">Params: ${model.parameter_size} | Size: ${model.size}</small>
                                            </div>
                                            <div>
                                                <span class="badge bg-success">${model.status}</span>
                                            </div>
                                        </div>
                                      `).join('') :
                    '<p class="text-muted">No models running</p>'
                }
                                </div>

                                ${dashboardSettings.showDisk ? `
                                <!-- 磁盘使用情况 -->
                                <div class="metric-card">
                                    <h6><i class="fa-solid fa-hdd"></i> Disk Usage</h6>
                                    ${data.system_resources.disk_info && data.system_resources.disk_info.length > 0 ?
                        data.system_resources.disk_info.map(disk => `
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between">
                                                <strong>${disk.mount_point}</strong>
                                                <span class="badge bg-info">${disk.percent}%</span>
                                            </div>
                                            <div class="progress mb-1">
                                                <div class="progress-bar" role="progressbar"
                                                    style="width: ${disk.percent}%"
                                                    aria-valuenow="${disk.percent}"
                                                    aria-valuemin="0" aria-valuemax="100">
                                                    ${disk.percent}%
                                                </div>
                                            </div>
                                            <small>${disk.filesystem} | ${disk.size} total | ${disk.used} used</small>
                                        </div>
                                      `).join('') :
                        '<p class="text-muted">No disk info available</p>'
                    }
                                </div>
                                ` : ''}

                                ${dashboardSettings.showNetwork ? `
                                <!-- 网络使用情况 -->
                                <div class="metric-card">
                                    <h6><i class="fa-solid fa-network-wired"></i> Network Usage</h6>
                                    ${data.system_resources.network_info && data.system_resources.network_info.length > 0 ?
                        data.system_resources.network_info.map(network => `
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between">
                                                <strong>${network.interface}</strong>
                                                <span>Recv: ${(network.receive_bytes / (1024 * 1024)).toFixed(2)} MB | Trans: ${(network.transmit_bytes / (1024 * 1024)).toFixed(2)} MB</span>
                                            </div>
                                            <small>Packets - Recv: ${network.receive_packets} | Trans: ${network.transmit_packets}</small>
                                        </div>
                                      `).join('') :
                        '<p class="text-muted">No network info available</p>'
                    }
                                </div>
                                ` : ''}

                                ${dashboardSettings.showTemp ? `
                                <!-- 硬件温度信息 -->
                                <div class="metric-card">
                                    <h6><i class="fa-solid fa-thermometer-half"></i> Hardware Temperature</h6>
                                    ${data.gpu_info && data.gpu_info.length > 0 ?
                        data.gpu_info.map(gpu => `
                                        <div class="mb-2">
                                            <div class="d-flex justify-content-between">
                                                <strong>GPU ${gpu.index}: ${gpu.name}</strong>
                                                <span class="badge ${gpu.temperature > 80 ? 'bg-danger' : gpu.temperature > 70 ? 'bg-warning' : 'bg-success'}">
                                                    ${gpu.temperature}°C
                                                </span>
                                            </div>
                                        </div>
                                      `).join('') :
                        data.system_resources.hardware_temp_info && data.system_resources.hardware_temp_info.length > 0 ?
                            data.system_resources.hardware_temp_info.map(temp => `
                                          <div class="mb-2">
                                              <div class="d-flex justify-content-between">
                                                  <strong>${temp.sensor_name}</strong>
                                                  <span class="badge ${temp.temperature > 70 ? 'bg-danger' : temp.temperature > 50 ? 'bg-warning' : 'bg-success'}">
                                                      ${temp.temperature}${temp.unit}
                                                  </span>
                                              </div>
                                          </div>
                                        `).join('') :
                            '<p class="text-muted">No temperature info available</p>'
                    }
                                </div>
                                ` : ''}

                                ${dashboardSettings.showCustomCmd ? `
                                <!-- 自定义命令结果 -->
                                <div class="metric-card">
                                    <h6><i class="fa-solid fa-terminal"></i> Custom Commands</h6>
                                    ${data.system_resources.custom_command_results && data.system_resources.custom_command_results.length > 0 ?
                        data.system_resources.custom_command_results.map(result => `
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between">
                                                <strong>${result.command.substring(0, 30)}${result.command.length > 30 ? '...' : ''}</strong>
                                                <span class="badge ${result.success ? 'bg-success' : 'bg-danger'}">
                                                    ${result.success ? 'Success' : 'Error'}
                                                </span>
                                            </div>
                                            <div class="mt-1">
                                                <small class="text-muted">Time: ${result.execution_time.toFixed(2)}s</small>
                                            </div>
                                            <div class="mt-1">
                                                <pre class="p-2 bg-light rounded" style="font-size: 0.8em; max-height: 100px; overflow-y: auto;">${result.output.substring(0, 100)}${result.output.length > 100 ? '...' : ''}</pre>
                                            </div>
                                        </div>
                                      `).join('') :
                        '<p class="text-muted">No custom commands configured</p>'
                    }
                                </div>
                                ` : ''}

                                <!-- GPU进程信息 -->
                                <div class="metric-card">
                                    <h6>GPU Processes</h6>
                                    ${data.gpu_info && data.gpu_info.some(gpu => gpu.processes && gpu.processes.length > 0) ?
                    data.gpu_info.map(gpu => `
                                        <div class="mb-3">
                                            <h7>GPU ${gpu.index} Processes</h7>
                                            ${gpu.processes && gpu.processes.length > 0 ?
                            gpu.processes.map(proc => `
                                                <div class="d-flex justify-content-between">
                                                    <div>
                                                        <span>${proc.process_name}</span><br>
                                                        <small class="text-muted">PID: ${proc.pid}</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <span class="badge bg-info">${proc.memory_used} MiB</span>
                                                    </div>
                                                </div>
                                              `).join('') :
                            '<p class="text-muted">No processes</p>'
                        }
                                        </div>
                                      `).join('') :
                    '<p class="text-muted">No GPU processes</p>'
                }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;

            // 只有当内容真正改变时才更新DOM，以减少闪烁
            if (serverDetail.innerHTML !== html) {
                serverDetail.innerHTML = html;
            }
        }

        // 仪表盘定制相关变量
        let dashboardSettings = {
            showCpu: true,
            showMemory: true,
            showGpu: true,
            showDisk: true,
            showNetwork: true,
            showTemp: true,
            showCustomCmd: true,
            showCharts: true,
            refreshInterval: 1000, // 毫秒
            theme: 'light'
        };

        // 图表相关变量
        let cpuChart, memoryChart, gpuChart, diskChart;
        let chartData = {
            cpu: { labels: [], data: [] },
            memory: { labels: [], data: [] },
            gpu: { labels: [], data: [] },
            disk: { labels: [], data: [] }
        };

        // 加载保存的设置
        function loadDashboardSettings() {
            const savedSettings = localStorage.getItem('dashboardSettings');
            if (savedSettings) {
                dashboardSettings = { ...dashboardSettings, ...JSON.parse(savedSettings) };

                // 更新UI以反映保存的设置
                document.getElementById('showCpu').checked = dashboardSettings.showCpu;
                document.getElementById('showMemory').checked = dashboardSettings.showMemory;
                document.getElementById('showGpu').checked = dashboardSettings.showGpu;
                document.getElementById('showDisk').checked = dashboardSettings.showDisk;
                document.getElementById('showNetwork').checked = dashboardSettings.showNetwork;
                document.getElementById('showTemp').checked = dashboardSettings.showTemp;
                document.getElementById('showCustomCmd').checked = dashboardSettings.showCustomCmd;
                document.getElementById('showCharts').checked = dashboardSettings.showCharts;
                document.getElementById('refreshInterval').value = dashboardSettings.refreshInterval / 1000;
                document.getElementById('themeSelector').value = dashboardSettings.theme;

                // 应用保存的主题
                applyTheme(dashboardSettings.theme);
            }
        }

        // 保存设置
        function saveDashboardSettings() {
            localStorage.setItem('dashboardSettings', JSON.stringify(dashboardSettings));
        }

        // 应用定制设置
        function applyDashboardSettings() {
            // 更新设置
            dashboardSettings.showCpu = document.getElementById('showCpu').checked;
            dashboardSettings.showMemory = document.getElementById('showMemory').checked;
            dashboardSettings.showGpu = document.getElementById('showGpu').checked;
            dashboardSettings.showDisk = document.getElementById('showDisk').checked;
            dashboardSettings.showNetwork = document.getElementById('showNetwork').checked;
            dashboardSettings.showTemp = document.getElementById('showTemp').checked;
            dashboardSettings.showCustomCmd = document.getElementById('showCustomCmd').checked;
            dashboardSettings.showCharts = document.getElementById('showCharts').checked;
            dashboardSettings.refreshInterval = parseInt(document.getElementById('refreshInterval').value) * 1000;
            dashboardSettings.theme = document.getElementById('themeSelector').value;

            // 保存设置
            saveDashboardSettings();

            // 应用主题
            applyTheme(dashboardSettings.theme);

            // 控制图表显示/隐藏
            toggleChartsVisibility();

            // 重新初始化WebSocket连接以应用新的刷新间隔
            if (allWsConnection) {
                allWsConnection.close();
            }
            for (const server in wsConnections) {
                wsConnections[server].close();
            }
            setTimeout(initWebSocket, 100);
        }

        // 应用主题
        function applyTheme(theme) {
            const body = document.body;
            if (theme === 'dark') {
                body.classList.add('dark-theme');
            } else {
                body.classList.remove('dark-theme');
            }
        }

        // 控制图表显示/隐藏
        function toggleChartsVisibility() {
            const chartsContainer = document.getElementById('chartsContainer');
            if (chartsContainer) {
                if (dashboardSettings.showCharts) {
                    chartsContainer.style.display = 'block';
                } else {
                    chartsContainer.style.display = 'none';
                }
            }
        }

        // 初始化图表
        function initCharts() {
            const cpuCtx = document.getElementById('cpuChart').getContext('2d');
            const memoryCtx = document.getElementById('memoryChart').getContext('2d');
            const gpuCtx = document.getElementById('gpuChart').getContext('2d');
            const diskCtx = document.getElementById('diskChart').getContext('2d');
            const gpuOverviewCtx = document.getElementById('gpuOverviewChart').getContext('2d');

            cpuChart = new Chart(cpuCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU Usage (%)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            memoryChart = new Chart(memoryCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Memory Usage (%)',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            gpuChart = new Chart(gpuCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'GPU Usage (%)',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            diskChart = new Chart(diskCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Disk Usage (%)',
                        data: [],
                        borderColor: 'rgb(255, 205, 86)',
                        backgroundColor: 'rgba(255, 205, 86, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });

            // GPU概览图表
            window.gpuOverviewChart = new Chart(gpuOverviewCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'GPU Usage (%)',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // 更新图表
        function updateCharts(data) {
            const now = new Date().toLocaleTimeString();

            // 计算平均值用于图表
            let totalCpu = 0, totalMemory = 0, totalGpu = 0, totalDisk = 0;
            let cpuCount = 0, memoryCount = 0, gpuCount = 0, diskCount = 0;

            // 用于GPU概览图表的数据
            let gpuOverviewAvg = 0;
            let gpuCountForOverview = 0;

            for (const serverName in data) {
                const serverData = data[serverName];
                if (serverData.error) continue;

                // CPU数据
                if (serverData.system_resources && serverData.system_resources.cpu_percent !== undefined) {
                    totalCpu += serverData.system_resources.cpu_percent;
                    cpuCount++;
                }

                // 内存数据
                if (serverData.system_resources && serverData.system_resources.memory_total > 0) {
                    const memoryPercent = (serverData.system_resources.memory_used / serverData.system_resources.memory_total) * 100;
                    totalMemory += memoryPercent;
                    memoryCount++;
                }

                // GPU数据
                if (serverData.gpu_info && serverData.gpu_info.length > 0) {
                    const avgGpu = serverData.gpu_info.reduce((sum, gpu) => sum + gpu.utilization, 0) / serverData.gpu_info.length;
                    totalGpu += avgGpu;
                    gpuCount++;

                    // 为GPU概览图表收集平均数据
                    gpuOverviewAvg += avgGpu;
                    gpuCountForOverview++;
                }

                // 磁盘数据
                if (serverData.system_resources && serverData.system_resources.disk_info && serverData.system_resources.disk_info.length > 0) {
                    const avgDisk = serverData.system_resources.disk_info.reduce((sum, disk) => sum + disk.percent, 0) / serverData.system_resources.disk_info.length;
                    totalDisk += avgDisk;
                    diskCount++;
                }
            }

            // 计算平均值
            const avgCpu = cpuCount > 0 ? totalCpu / cpuCount : 0;
            const avgMemory = memoryCount > 0 ? totalMemory / memoryCount : 0;
            const avgGpu = gpuCount > 0 ? totalGpu / gpuCount : 0;
            const avgDisk = diskCount > 0 ? totalDisk / diskCount : 0;

            // 更新数据数组（保留最近20个数据点）
            chartData.cpu.labels.push(now);
            chartData.cpu.data.push(avgCpu);
            if (chartData.cpu.labels.length > 20) {
                chartData.cpu.labels.shift();
                chartData.cpu.data.shift();
            }

            chartData.memory.labels.push(now);
            chartData.memory.data.push(avgMemory);
            if (chartData.memory.labels.length > 20) {
                chartData.memory.labels.shift();
                chartData.memory.data.shift();
            }

            chartData.gpu.labels.push(now);
            chartData.gpu.data.push(avgGpu);
            if (chartData.gpu.labels.length > 20) {
                chartData.gpu.labels.shift();
                chartData.gpu.data.shift();
            }

            chartData.disk.labels.push(now);
            chartData.disk.data.push(avgDisk);
            if (chartData.disk.labels.length > 20) {
                chartData.disk.labels.shift();
                chartData.disk.data.shift();
            }

            // 更新图表
            cpuChart.data.labels = chartData.cpu.labels;
            cpuChart.data.datasets[0].data = chartData.cpu.data;
            cpuChart.update();

            memoryChart.data.labels = chartData.memory.labels;
            memoryChart.data.datasets[0].data = chartData.memory.data;
            memoryChart.update();

            gpuChart.data.labels = chartData.gpu.labels;
            gpuChart.data.datasets[0].data = chartData.gpu.data;
            gpuChart.update();

            diskChart.data.labels = chartData.disk.labels;
            diskChart.data.datasets[0].data = chartData.disk.data;
            diskChart.update();

            // 更新GPU概览图表
            if (window.gpuOverviewChart) {
                // 计算平均GPU利用率
                const avgGpuOverview = gpuCountForOverview > 0 ? gpuOverviewAvg / gpuCountForOverview : 0;

                // 更新数据数组（保留最近20个数据点）
                window.gpuOverviewChart.data.labels.push(now);
                window.gpuOverviewChart.data.datasets[0].data.push(avgGpuOverview);

                if (window.gpuOverviewChart.data.labels.length > 20) {
                    window.gpuOverviewChart.data.labels.shift();
                    window.gpuOverviewChart.data.datasets[0].data.shift();
                }

                window.gpuOverviewChart.update();
            }
        }

        // 获取服务器列表，带缓存功能
        async function getServerList() {
            if (cachedServerList) {
                // 如果已有缓存，直接返回缓存结果
                return cachedServerList;
            }

            try {
                const response = await fetch('/api/servers');
                const data = await response.json();

                // 缓存结果
                cachedServerList = data;
                return data;
            } catch (error) {
                console.error('Error fetching server list:', error);
                throw error;
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function () {
            // 加载保存的设置
            loadDashboardSettings();

            // 初始化图表
            initCharts();

            // 控制图表显示/隐藏
            toggleChartsVisibility();

            // 为应用定制按钮添加事件监听器
            document.getElementById('applyCustomization').addEventListener('click', function () {
                applyDashboardSettings();
                // 关闭模态框
                bootstrap.Modal.getInstance(document.getElementById('customizeModal')).hide();
            });

            // 从API获取服务器列表
            getServerList()
                .then(data => {
                    if (data && data.servers) {
                        servers = data.servers;
                        initWebSocket();
                    } else {
                        console.error('Invalid server data received:', data);
                        // 使用配置中的服务器名称作为备用
                        servers = ['Server - ps'];
                        initWebSocket();
                    }
                })
                .catch(error => {
                    console.error('Error fetching server list:', error);
                    // 使用配置中的服务器名称作为备用
                    servers = ['Server - ps'];
                    initWebSocket();
                });

            // CLI功能相关代码
            let cliWebSocket = null;
            let selectedServerForCLI = null;
            let currentConnectedServer = null;

            document.getElementById('cliBtn').addEventListener('click', async function() {
                // 获取服务器列表并填充下拉菜单
                try {
                    const data = await getServerList();  // 使用缓存的服务器列表

                    const serverSelect = document.getElementById('cliServerSelect');
                    serverSelect.innerHTML = '';

                    if (data && data.servers) {
                        data.servers.forEach(server => {
                            const displayName = `${server.name} (${server.host})`;

                            const option = document.createElement('option');
                            option.value = server.name;
                            option.textContent = displayName;
                            serverSelect.appendChild(option);
                        });

                        // 如果有服务器，选择第一个
                        if (data.servers.length > 0) {
                            selectedServerForCLI = data.servers[0].name;
                            serverSelect.value = selectedServerForCLI;

                            // 清空输出区域
                            document.getElementById('cliOutput').innerHTML = '';
                            document.getElementById('cliInput').value = '';

                            // 自动执行pwd命令显示当前目录
                            addToCliOutput(`<span class="text-success">Connected to ${serverSelect.options[serverSelect.selectedIndex].text}</span><br>`);
                            addToCliOutput(`<span class="text-info">$ pwd</span><br>`);

                            // 执行pwd命令
                            await executeCliCommand('pwd');
                        }
                    } else {
                        console.warn('No servers returned from API');
                        document.getElementById('cliOutput').innerHTML = '<span class="text-warning">No servers available</span><br>';
                    }

                } catch (error) {
                    console.error('Error fetching server list for CLI:', error);
                    document.getElementById('cliOutput').innerHTML = `<p class="text-danger">Error fetching server list: ${error.message}</p>`;
                }
            });

            // 服务器选择变化事件
            document.getElementById('cliServerSelect').addEventListener('change', function() {
                selectedServerForCLI = this.value;
                // 关闭当前WebSocket连接，以便下次命令执行时连接到新服务器
                if (cliWebSocket) {
                    cliWebSocket.close();
                    cliWebSocket = null;
                    currentConnectedServer = null;
                }
            });

            // CLI输入框回车事件
            document.getElementById('cliInput').addEventListener('keypress', async function(e) {
                if (e.key === 'Enter') {
                    const command = this.value.trim();

                    if (!selectedServerForCLI) {
                        addToCliOutput('<span class="text-danger">Error: No server selected</span><br>');
                        this.value = '';
                        return;
                    }

                    // 如果输入为空，只是换行
                    if (!command) {
                        addToCliOutput('\n');
                        this.value = '';
                        return;
                    }

                    // 添加用户输入的命令到输出（显示在终端中）
                    addToCliOutput(`<span class="text-info">$ ${command}</span>\n`);

                    // 执行命令
                    await executeCliCommand(command);

                    // 清空输入框
                    this.value = '';
                }
            });

            // 执行CLI命令函数
            async function executeCliCommand(command) {
                // 确保选择了服务器
                if (!selectedServerForCLI) {
                    addToCliOutput('<span class="text-danger">Error: No server selected</span><br>');
                    return;
                }

                // 如果WebSocket未连接或连接到不同的服务器，则建立新连接
                if (!cliWebSocket || !cliWebSocket.readyState || cliWebSocket.readyState !== WebSocket.OPEN || currentConnectedServer !== selectedServerForCLI) {
                    await connectCliWebSocket(selectedServerForCLI);

                    // 等待连接建立
                    if (cliWebSocket.readyState === WebSocket.CONNECTING) {
                        await new Promise((resolve) => {
                            const checkReadyState = setInterval(() => {
                                if (cliWebSocket.readyState === WebSocket.OPEN) {
                                    clearInterval(checkReadyState);
                                    resolve();
                                }
                            }, 100);

                            setTimeout(() => {
                                clearInterval(checkReadyState);
                                resolve();
                            }, 5000);
                        });
                    }
                }

                // 发送命令
                const commandObj = {
                    command: command,
                    use_sudo: document.getElementById('cliUseSudo').checked
                };

                if (cliWebSocket.readyState === WebSocket.OPEN) {
                    cliWebSocket.send(JSON.stringify(commandObj));
                } else {
                    addToCliOutput('<span class="text-danger">Error: WebSocket is not open</span><br>');
                }
            }

            // 连接CLI WebSocket
            async function connectCliWebSocket(serverName) {
                // 如果已有连接，先关闭
                if (cliWebSocket) {
                    cliWebSocket.close();
                }

                // 建立新连接
                cliWebSocket = new WebSocket(`ws://${window.location.host}/ws/cli/${serverName}`);
                currentConnectedServer = serverName;

                cliWebSocket.onopen = function(event) {
                    addToCliOutput(`<span class="text-success">Connected to ${serverName}</span><br>`);
                };

                cliWebSocket.onmessage = function(event) {
                    const data = JSON.parse(event.data);

                    if (data.error) {
                        addToCliOutput(`<span class="text-danger">Error: ${data.error}</span><br>`);
                    } else {
                        // 显示命令输出
                        if (data.stdout) {
                            // 处理换行符和特殊字符
                            let formattedOutput = data.stdout.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                            formattedOutput = formattedOutput.replace(/\n/g, '<br>').replace(/\r/g, '');
                            addToCliOutput(formattedOutput);
                        }
                        if (data.stderr) {
                            // 错误输出用红色显示
                            let formattedError = data.stderr.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                            formattedError = formattedError.replace(/\n/g, '<br>').replace(/\r/g, '');
                            addToCliOutput(`<span class="text-danger">${formattedError}</span><br>`);
                        }

                        // 如果命令执行失败，显示状态
                        if (!data.success && !(data.stdout || data.stderr)) {
                            addToCliOutput(`<span class="text-danger">Command failed</span><br>`);
                        }
                    }
                };

                cliWebSocket.onclose = function(event) {
                    currentConnectedServer = null;
                    addToCliOutput(`<span class="text-warning">Disconnected from ${serverName}</span><br>`);
                };

                cliWebSocket.onerror = function(error) {
                    addToCliOutput(`<span class="text-danger">WebSocket error</span><br>`);
                };
            }

            // 添加内容到CLI输出区域
            function addToCliOutput(content) {
                const outputDiv = document.getElementById('cliOutput');
                outputDiv.innerHTML += content;

                // 自动滚动到底部
                outputDiv.scrollTop = outputDiv.scrollHeight;

                // 将焦点放回输入框，以便继续输入
                document.getElementById('cliInput').focus();
            }

            // CLI清除输出按钮
            document.getElementById('cliClearBtn').addEventListener('click', function() {
                document.getElementById('cliOutput').innerHTML = '';
                document.getElementById('cliInput').value = '';
            });
        });

        // Docker功能相关代码
        document.getElementById('dockerBtn').addEventListener('click', async function() {
            // 显示加载状态
            const dockerContent = document.getElementById('dockerContent');
            dockerContent.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>';

            // 获取服务器列表并获取Docker信息
            try {
                const serverData = await getServerList();

                if (serverData && serverData.servers) {
                    let dockerHtml = '';

                    for (const serverObj of serverData.servers) {
                        const serverName = serverObj.name;
                        dockerHtml += `<h5 class="mt-4">${serverName}</h5>`;

                        // 获取容器信息
                        const containersResponse = await fetch(`/api/docker/containers/${serverName}`);
                        const containersData = await containersResponse.json();

                        if (containersData.containers) {
                            dockerHtml += `<h6>Running Containers:</h6>`;
                            if (containersData.containers.length > 0) {
                                dockerHtml += `
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Name</th>
                                                <th>Status</th>
                                                <th>Ports</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                `;

                                containersData.containers.forEach(container => {
                                    dockerHtml += `
                                        <tr>
                                            <td><code>${container.ID}</code></td>
                                            <td>${container.Name}</td>
                                            <td>${container.Status}</td>
                                            <td>${container.Ports}</td>
                                        </tr>
                                    `;
                                });

                                dockerHtml += `
                                        </tbody>
                                    </table>
                                </div>
                                `;
                            } else {
                                dockerHtml += '<p class="text-muted">No running containers</p>';
                            }
                        } else {
                            dockerHtml += `<p class="text-danger">Error: ${containersData.error || 'Unknown error'}</p>`;
                        }

                        // 获取镜像信息
                        const imagesResponse = await fetch(`/api/docker/images/${serverName}`);
                        const imagesData = await imagesResponse.json();

                        if (imagesData.images) {
                            dockerHtml += `<h6>Docker Images:</h6>`;
                            if (imagesData.images.length > 0) {
                                dockerHtml += `
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead>
                                            <tr>
                                                <th>Repository</th>
                                                <th>Tag</th>
                                                <th>ID</th>
                                                <th>Size</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                `;

                                imagesData.images.forEach(image => {
                                    dockerHtml += `
                                        <tr>
                                            <td>${image.Repository}</td>
                                            <td>${image.Tag}</td>
                                            <td><code>${image.ID}</code></td>
                                            <td>${image.Size}</td>
                                        </tr>
                                    `;
                                });

                                dockerHtml += `
                                        </tbody>
                                    </table>
                                </div>
                                `;
                            } else {
                                dockerHtml += '<p class="text-muted">No images found</p>';
                            }
                        } else {
                            dockerHtml += `<p class="text-danger">Error: ${imagesData.error || 'Unknown error'}</p>`;
                        }
                    }

                    dockerContent.innerHTML = dockerHtml;
                }
            } catch (error) {
                console.error('Error fetching Docker data:', error);
                dockerContent.innerHTML = `<p class="text-danger">Error fetching Docker data: ${error.message}</p>`;
            }
        });

        // CLI功能相关代码
        let cliWebSocket = null;
        let selectedServerForCLI = null;
        let currentConnectedServer = null;

        document.getElementById('cliBtn').addEventListener('click', async function() {
            // 获取服务器列表并填充下拉菜单
            try {
                const data = await getServerList();  // 使用缓存的服务器列表

                const serverSelect = document.getElementById('cliServerSelect');
                serverSelect.innerHTML = '';

                if (data && data.servers) {
                    data.servers.forEach(server => {
                        const displayName = `${server.name} (${server.host})`;

                        const option = document.createElement('option');
                        option.value = server.name;
                        option.textContent = displayName;
                        serverSelect.appendChild(option);
                    });

                    // 如果有服务器，选择第一个
                    if (data.servers.length > 0) {
                        selectedServerForCLI = data.servers[0].name;
                        serverSelect.value = selectedServerForCLI;

                        // 清空输出区域
                        document.getElementById('cliOutput').innerHTML = '';
                        document.getElementById('cliInput').value = '';

                        // 显示连接信息
                        addToCliOutput(`<span class="text-success">Connected to ${serverSelect.options[serverSelect.selectedIndex].text}</span><br>`);

                        // 建立WebSocket连接并执行pwd命令
                        await connectCliWebSocket(selectedServerForCLI);

                        // 等待连接建立
                        if (cliWebSocket.readyState === WebSocket.CONNECTING) {
                            await new Promise((resolve) => {
                                const checkReadyState = setInterval(() => {
                                    if (cliWebSocket.readyState === WebSocket.OPEN) {
                                        clearInterval(checkReadyState);
                                        resolve();
                                    }
                                }, 100);

                                setTimeout(() => {
                                    clearInterval(checkReadyState);
                                    resolve();
                                }, 5000);
                            });
                        }

                        // 发送pwd命令
                        if (cliWebSocket.readyState === WebSocket.OPEN) {
                            const commandObj = {
                                command: 'pwd',
                                use_sudo: false
                            };
                            cliWebSocket.send(JSON.stringify(commandObj));
                            addToCliOutput(`<span class="text-info">$ pwd</span><br>`);
                        }
                    }
                } else {
                    console.warn('No servers returned from API');
                    document.getElementById('cliOutput').innerHTML = '<span class="text-warning">No servers available</span><br>';
                }

            } catch (error) {
                console.error('Error fetching server list for CLI:', error);
                document.getElementById('cliOutput').innerHTML = `<p class="text-danger">Error fetching server list: ${error.message}</p>`;
            }
        });

        // 服务器选择变化事件
        document.getElementById('cliServerSelect').addEventListener('change', function() {
            selectedServerForCLI = this.value;
            // 关闭当前WebSocket连接，以便下次命令执行时连接到新服务器
            if (cliWebSocket) {
                cliWebSocket.close();
                cliWebSocket = null;
                currentConnectedServer = null;
            }
        });

        // CLI输入框回车事件
        document.getElementById('cliInput').addEventListener('keypress', async function(e) {
            if (e.key === 'Enter') {
                const command = this.value.trim();

                if (!selectedServerForCLI) {
                    addToCliOutput('<span class="text-danger">Error: No server selected</span><br>');
                    this.value = '';
                    return;
                }

                // 添加用户输入的命令到输出（显示在终端中）
                addToCliOutput(`<span class="text-info">$ ${command}</span>\n`);

                // 如果输入为空，只是换行
                if (!command) {
                    addToCliOutput('\n');
                    this.value = '';
                    return;
                }

                // 执行命令
                await executeCliCommand(command);

                // 清空输入框
                this.value = '';
            }
        });

        // 执行CLI命令函数
        async function executeCliCommand(command) {
            // 确保选择了服务器
            if (!selectedServerForCLI) {
                addToCliOutput('<span class="text-danger">Error: No server selected</span><br>');
                return;
            }

            // 如果WebSocket未连接或连接到不同的服务器，则建立新连接
            if (!cliWebSocket || !cliWebSocket.readyState || cliWebSocket.readyState !== WebSocket.OPEN || currentConnectedServer !== selectedServerForCLI) {
                await connectCliWebSocket(selectedServerForCLI);
            }

            // 等待连接建立后再发送命令
            if (cliWebSocket.readyState === WebSocket.CONNECTING) {
                // 等待一段时间直到连接建立
                await new Promise((resolve) => {
                    const checkReadyState = setInterval(() => {
                        if (cliWebSocket.readyState === WebSocket.OPEN) {
                            clearInterval(checkReadyState);
                            resolve();
                        }
                    }, 100);

                    // 设置最大等待时间
                    setTimeout(() => {
                        clearInterval(checkReadyState);
                        resolve();
                    }, 5000); // 5秒后放弃等待
                });
            }

            // 发送命令
            const commandObj = {
                command: command,
                use_sudo: document.getElementById('cliUseSudo').checked
            };

            if (cliWebSocket.readyState === WebSocket.OPEN) {
                cliWebSocket.send(JSON.stringify(commandObj));
            } else {
                addToCliOutput('<span class="text-danger">Error: WebSocket is not open</span><br>');
            }
        }

        // 连接CLI WebSocket
        async function connectCliWebSocket(serverName) {
            // 如果已有连接，先关闭
            if (cliWebSocket) {
                cliWebSocket.close();
            }

            // 建立新连接
            cliWebSocket = new WebSocket(`ws://${window.location.host}/ws/cli/${serverName}`);
            currentConnectedServer = serverName;

            cliWebSocket.onopen = function(event) {
                addToCliOutput(`<span class="text-success">Connected to ${serverName}</span><br>`);
            };

            cliWebSocket.onmessage = function(event) {
                const data = JSON.parse(event.data);

                if (data.error) {
                    addToCliOutput(`<span class="text-danger">Error: ${data.error}</span><br>`);
                } else {
                    // 显示命令输出
                    if (data.stdout) {
                        // 处理换行符和特殊字符
                        let formattedOutput = data.stdout.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        formattedOutput = formattedOutput.replace(/\n/g, '<br>').replace(/\r/g, '');
                        addToCliOutput(formattedOutput);
                    }
                    if (data.stderr) {
                        // 错误输出用红色显示
                        let formattedError = data.stderr.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                        formattedError = formattedError.replace(/\n/g, '<br>').replace(/\r/g, '');
                        // 特殊处理sudo密码提示
                        if (formattedError.includes('[sudo] password for')) {
                            formattedError = 'Sudo password prompt detected. Please configure sudo_password in server config.';
                        }
                        addToCliOutput(`<span class="text-danger">${formattedError}</span><br>`);
                    }

                    // 如果命令执行失败，显示状态
                    if (!data.success && !(data.stdout || data.stderr)) {
                        addToCliOutput(`<span class="text-danger">Command failed</span><br>`);
                    }
                }
            };

            cliWebSocket.onclose = function(event) {
                currentConnectedServer = null;
                addToCliOutput(`<span class="text-warning">Disconnected from ${serverName}</span><br>`);
            };

            cliWebSocket.onerror = function(error) {
                addToCliOutput(`<span class="text-danger">WebSocket error</span><br>`);
            };
        }

        // 添加内容到CLI输出区域
        function addToCliOutput(content) {
            const outputDiv = document.getElementById('cliOutput');
            outputDiv.innerHTML += content;

            // 自动滚动到底部
            outputDiv.scrollTop = outputDiv.scrollHeight;

            // 将焦点放回输入框，以便继续输入
            document.getElementById('cliInput').focus();
        }

        // CLI清除输出按钮
        document.getElementById('cliClearBtn').addEventListener('click', function() {
            document.getElementById('cliOutput').innerHTML = '';
            document.getElementById('cliInput').value = '';
        });

        // GPU历史峰值功能
        let gpuHistoryChart = null;

        // 初始化GPU历史峰值模态框
        document.getElementById('gpuHistoryBtn').addEventListener('click', async function() {
            // 填充服务器选择下拉菜单
            try {
                console.log('Fetching server list for GPU history...');
                const data = await getServerList();  // 使用缓存的服务器列表
                console.log('Fetched server list for GPU history:', data);

                const serverSelect = document.getElementById('gpuServerSelect');
                if (!serverSelect) {
                    console.error('gpuServerSelect element not found!');
                    return;
                }

                serverSelect.innerHTML = '';

                if (data && data.servers && Array.isArray(data.servers)) {
                    console.log(`Found ${data.servers.length} servers`);
                    data.servers.forEach(serverObj => {
                        console.log('Processing server:', serverObj);
                        // 服务器对象包含name和host属性
                        const serverName = serverObj.name;
                        const serverHost = serverObj.host;
                        const option = document.createElement('option');
                        option.value = serverName;
                        option.textContent = `${serverName} (${serverHost})`;  // 显示名称和主机
                        serverSelect.appendChild(option);
                        console.log(`Added option: ${serverName} (${serverHost})`);
                    });

                    // 如果有服务器，选择第一个
                    if (data.servers.length > 0) {
                        serverSelect.value = data.servers[0].name;
                        console.log('Selected first server:', data.servers[0].name);
                        // 自动加载第一个服务器的数据
                        await loadGpuHistoryData();
                    } else {
                        console.log('No servers found in response');
                    }
                } else {
                    console.log('No servers in response or invalid format');
                }
            } catch (error) {
                console.error('Error fetching server list for GPU history:', error);
                console.error('Stack trace:', error.stack);
            }
        });

        // 加载GPU历史数据
        async function loadGpuHistoryData() {
            const serverName = document.getElementById('gpuServerSelect').value;
            const timeRange = parseInt(document.getElementById('gpuTimeRange').value);
            const minUtilization = parseInt(document.getElementById('gpuMinUtilization').value);

            if (!serverName) {
                alert('Please select a server');
                return;
            }

            try {
                // 显示加载状态
                document.getElementById('gpuHistoryTbody').innerHTML = '<tr><td colspan="5" class="text-center">Loading...</td></tr>';

                // 获取数据
                const response = await fetch(`/api/gpu-history-peaks/${serverName}?hours=${timeRange}&min_utilization=${minUtilization}`);
                const result = await response.json();

                if (result.error) {
                    document.getElementById('gpuHistoryTbody').innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error: ${result.error}</td></tr>`;
                    return;
                }

                // 填充表格
                populateGpuHistoryTable(result.peak_data);

                // 更新统计数据
                updateGpuStatistics(result.peak_data);

                // 绘制图表
                drawGpuHistoryChart(result.peak_data);

            } catch (error) {
                console.error('Error loading GPU history data:', error);
                document.getElementById('gpuHistoryTbody').innerHTML = `<tr><td colspan="5" class="text-center text-danger">Error: ${error.message}</td></tr>`;
            }
        }

        // 填充GPU历史数据表格
        function populateGpuHistoryTable(data) {
            const tbody = document.getElementById('gpuHistoryTbody');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No data available</td></tr>';
                return;
            }

            data.forEach(item => {
                const row = document.createElement('tr');

                // 格式化时间戳
                const timestamp = new Date(item.timestamp).toLocaleString();

                row.innerHTML = `
                    <td>${timestamp}</td>
                    <td>${item.gpu_utilization !== null ? item.gpu_utilization : '-'}</td>
                    <td>${item.gpu_memory_used !== null ? item.gpu_memory_used : '-'}</td>
                    <td>${item.gpu_memory_total !== null ? item.gpu_memory_total : '-'}</td>
                    <td>${item.gpu_temperature !== null ? item.gpu_temperature : '-'}</td>
                `;

                tbody.appendChild(row);
            });
        }

        // 更新GPU统计信息
        function updateGpuStatistics(data) {
            if (!data || data.length === 0) {
                document.getElementById('gpuMaxValue').textContent = '-';
                document.getElementById('gpuAvgValue').textContent = '-';
                document.getElementById('gpuMinValue').textContent = '-';
                document.getElementById('gpuCountValue').textContent = '0';
                return;
            }

            // 计算统计值
            const utilizations = data
                .filter(item => item.gpu_utilization !== null)
                .map(item => item.gpu_utilization);

            if (utilizations.length === 0) {
                document.getElementById('gpuMaxValue').textContent = '-';
                document.getElementById('gpuAvgValue').textContent = '-';
                document.getElementById('gpuMinValue').textContent = '-';
                document.getElementById('gpuCountValue').textContent = '0';
                return;
            }

            const maxValue = Math.max(...utilizations);
            const minValue = Math.min(...utilizations);
            const avgValue = (utilizations.reduce((a, b) => a + b, 0) / utilizations.length).toFixed(2);

            document.getElementById('gpuMaxValue').textContent = maxValue;
            document.getElementById('gpuAvgValue').textContent = avgValue;
            document.getElementById('gpuMinValue').textContent = minValue;
            document.getElementById('gpuCountValue').textContent = utilizations.length;
        }

        // 绘制GPU历史图表
        function drawGpuHistoryChart(data) {
            const ctx = document.getElementById('gpuHistoryChart').getContext('2d');

            // 销毁现有图表（如果存在）
            if (gpuHistoryChart) {
                gpuHistoryChart.destroy();
            }

            if (!data || data.length === 0) {
                // 创建空图表
                gpuHistoryChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'GPU Utilization (%)',
                            data: [],
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
                return;
            }

            // 过滤有效的数据点
            const validData = data.filter(item => item.gpu_utilization !== null);

            if (validData.length === 0) {
                // 创建空图表
                gpuHistoryChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'GPU Utilization (%)',
                            data: [],
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
                return;
            }

            // 准备图表数据
            const labels = validData.map(item => new Date(item.timestamp).toLocaleTimeString());
            const gpuData = validData.map(item => item.gpu_utilization);

            // 创建新图表
            gpuHistoryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'GPU Utilization (%)',
                        data: gpuData,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Utilization (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });
        }

        // 为GPU历史加载按钮添加事件监听器
        document.getElementById('loadGpuHistoryBtn').addEventListener('click', loadGpuHistoryData);
        document.getElementById('refreshGpuHistoryBtn').addEventListener('click', loadGpuHistoryData);

        // 当服务器选择变化时，自动加载数据
        // 注意：这些事件监听器需要在DOM元素存在后才能绑定
        setTimeout(function() {
            const serverSelect = document.getElementById('gpuServerSelect');
            if (serverSelect) {
                serverSelect.addEventListener('change', loadGpuHistoryData);
            }

            const timeRangeSelect = document.getElementById('gpuTimeRange');
            if (timeRangeSelect) {
                timeRangeSelect.addEventListener('change', loadGpuHistoryData);
            }

            const minUtilInput = document.getElementById('gpuMinUtilization');
            if (minUtilInput) {
                minUtilInput.addEventListener('change', loadGpuHistoryData);
            }
        }, 100); // 延迟一点时间确保DOM元素已创建

    </script>

    <!-- Docker Modal -->
    <div class="modal fade" id="dockerModal" tabindex="-1" aria-labelledby="dockerModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dockerModalLabel">Docker Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="dockerContent">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- GPU History Modal -->
    <div class="modal fade" id="gpuHistoryModal" tabindex="-1" aria-labelledby="gpuHistoryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="gpuHistoryModalLabel">GPU History Peaks</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="gpuServerSelect" class="form-label">Server:</label>
                                <select class="form-select" id="gpuServerSelect"></select>
                            </div>
                            <div class="col-md-4">
                                <label for="gpuTimeRange" class="form-label">Time Range (hours):</label>
                                <select class="form-select" id="gpuTimeRange">
                                    <option value="1">1 hour</option>
                                    <option value="6" selected>6 hours</option>
                                    <option value="24">24 hours</option>
                                    <option value="168">7 days</option>
                                    <option value="720">30 days</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="gpuMinUtilization" class="form-label">Min Utilization (%):</label>
                                <input type="number" class="form-control" id="gpuMinUtilization" value="10" min="0" max="100">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <button id="loadGpuHistoryBtn" class="btn btn-primary">Load Data</button>
                        <button id="refreshGpuHistoryBtn" class="btn btn-success">Refresh</button>
                    </div>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">GPU Utilization Over Time</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="gpuHistoryChart" height="300"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Peak Statistics</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-group" id="gpuStatsList">
                                        <li class="list-group-item">Max: <span id="gpuMaxValue">-</span>%</li>
                                        <li class="list-group-item">Average: <span id="gpuAvgValue">-</span>%</li>
                                        <li class="list-group-item">Min: <span id="gpuMinValue">-</span>%</li>
                                        <li class="list-group-item">Count: <span id="gpuCountValue">-</span></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0">Peak Data Table</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="gpuHistoryTable">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>GPU Utilization (%)</th>
                                            <th>Memory Used (MB)</th>
                                            <th>Memory Total (MB)</th>
                                            <th>Temperature (°C)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="gpuHistoryTbody">
                                        <!-- Data will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CLI Modal -->
    <div class="modal fade" id="cliModal" tabindex="-1" aria-labelledby="cliModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cliModalLabel">Web CLI Terminal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="cliServerSelect" class="form-label">Select Server:</label>
                                <select class="form-select" id="cliServerSelect"></select>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="cliUseSudo">
                                    <label class="form-check-label" for="cliUseSudo">Execute with sudo</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">Terminal Output</h6>
                            <button id="cliClearBtn" class="btn btn-sm btn-outline-secondary">Clear</button>
                        </div>
                        <div class="card-body p-0">
                            <div id="cliOutput" class="terminal-output" style="height: 400px; overflow-y: auto; background-color: #000; color: #00FF00; font-family: 'Courier New', monospace; padding: 15px; white-space: pre-wrap;">
                                <!-- 命令输出将显示在这里 -->
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label for="cliInput" class="form-label">Command:</label>
                        <input type="text" class="form-control" id="cliInput" placeholder="Enter command here...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>