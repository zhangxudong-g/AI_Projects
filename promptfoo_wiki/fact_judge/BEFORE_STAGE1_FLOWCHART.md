# Stage 1 之前的流程图

## 整体流程

```mermaid
graph TD
    A[开始] --> B[运行主程序]
    B --> C{选择运行模式}
    C -->|批量运行| D[run_multi_cases.py]
    C -->|单案例运行| E[run_single_case_pipeline.py]
    C -->|直接运行| F[run_pipeline.py]
    
    D --> G[读取cases.yaml配置]
    G --> H[遍历每个测试案例]
    H --> I[获取案例ID和变量配置]
    I --> J[调用run_single_case函数]
    
    E --> K[接收案例参数]
    K --> L[创建输出目录]
    L --> M[解析变量配置]
    M --> N[提取源代码路径]
    N --> O[根据文件扩展名确定语言]
    O --> P[读取源代码内容]
    
    J --> P
    
    P --> Q[提取工程级锚点]
    Q --> R[识别代码元素:类/方法/函数等]
    R --> S[按语言类型处理]
    S -->|Python| T[提取类、函数、装饰器、导入等]
    S -->|Java| U[提取类、方法、注解、导入等]
    S -->|SQL| V[提取表、操作、存储过程、包等]
    
    T --> W[生成工程级事实]
    U --> W
    V --> W
    
    W --> X[使用LLM生成工程级事实描述]
    X --> Y[保存锚点和事实到输出目录]
    Y --> Z[拼接promptfoo命令参数]
    
    Z --> AA[执行Stage 1: 事实提取]
    AA --> AB[保存Stage 1结果]
    AB --> AC[准备进入Stage 2]
    

```

## 详细流程说明

### 1. 启动阶段
- 用户可以选择三种运行方式：
  - `run_multi_cases.py`：批量运行多个测试案例
  - `run_single_case_pipeline.py`：运行单个测试案例
  - `run_pipeline.py`：直接运行完整管道

### 2. 配置解析阶段
- 解析测试案例配置（cases.yaml）
- 提取每个案例的ID和变量配置
- 准备运行环境和输出目录

### 3. 源代码分析阶段
- 读取源代码文件内容
- 根据文件扩展名自动识别编程语言
- 提取工程级锚点（代码中的关键元素）

### 4. 工程级事实提取阶段
- 根据不同编程语言提取相应的代码元素：
  - Python: 类、函数、装饰器、导入语句等
  - Java: 类、方法、注解、导入语句等
  - SQL: 表、操作、存储过程、包、触发器等
- 使用LLM生成工程级事实描述
- 保存锚点和事实信息到输出目录

### 5. Stage 1 准备阶段
- 拼接promptfoo命令参数
- 包含工程级事实信息
- 准备执行Stage 1的评估