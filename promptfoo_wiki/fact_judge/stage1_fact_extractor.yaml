providers:
  - id: ollama:gpt-oss:120b
    config:
      temperature: 0
      top_p: 1
version: "1.0"

prompts:
  - |
    You are a FACT-BASED EVALUATION ENGINE.

    You are given:
    - SOURCE CODE (Java / Java Web / Spring MVC / SQL / PL-SQL)
    - GENERATED WIKI (Markdown)
    - ENGINEERING ANCHORS extracted from source code (classes, methods/functions, tables, packages, procedures, triggers, etc.)

    Your task is to evaluate how well the wiki matches the source code.

    =====================
    INPUTS
    =====================

    --- SOURCE CODE ---
    {{source_code}}

    --- GENERATED WIKI ---
    {{wiki_md}}

    --- ENGINEERING ANCHORS ---
    {{engineering_facts}}

    =====================
    CORE RULES (ABSOLUTE)
    =====================

    - Judge ONLY based on what is explicitly present in the source code.
    - DO NOT infer intent, design quality, or best practices.
    - DO NOT assume framework conventions.
    - DO NOT summarize or rewrite the wiki.
    - Every judgment MUST be traceable to concrete code elements.
    - If something cannot be proven from the source code, treat it as unsupported.

    =====================
    WHAT COUNTS AS SOURCE FACTS
    =====================

    --------
    Java / Java Web / MVC
    --------

    - Classes annotated with:
      @Controller
      @RestController
      @Service
      @Component
      @Repository

    - Public methods defined in those classes

    - HTTP endpoints explicitly defined via:
      @GetMapping
      @PostMapping
      @PutMapping
      @DeleteMapping
      @RequestMapping

    - Explicit method calls between classes
      (e.g. controller method calling a service method)

    --------
    SQL / PL-SQL
    --------

    - Database objects:
      TABLE, VIEW, INDEX, SEQUENCE

    - Program units:
      PROCEDURE, FUNCTION, PACKAGE, TRIGGER

    - Explicit dependencies:
      - Procedure/function calling another procedure/function
      - Trigger defined on a specific table
      - View defined based on tables

    =====================
    EVALUATION DIMENSIONS
    =====================

    You MUST evaluate the wiki in FOUR dimensions:

    ---------------------------------
    1. COVERAGE (Missing content)
    ---------------------------------

    Identify important source facts that are NOT mentioned in the wiki.

    For each missing item:
    - position: the approximate section or paragraph index in the wiki
      where this content should have appeared (start from 1).
    - content: a concise description of the missing fact.

    ---------------------------------
    2. CORRECTNESS (Mismatches)
    ---------------------------------

    Identify statements in the wiki that reference real source elements
    but describe them incorrectly.

    Examples:
    - Wrong annotation (Service described as Controller)
    - Wrong method name or responsibility
    - Wrong dependency or relationship

    For each mismatch:
    - position: the wiki paragraph index (starting from 1)
    - content: what is incorrect compared to the source code

    ---------------------------------
    3. HALLUCINATION (Invented facts)
    ---------------------------------

    Identify any wiki content that refers to:
    - Classes, methods, endpoints, tables, procedures
    - Behaviors or relationships

    that DO NOT exist in the source code at all.

    For each hallucination:
    - position: the wiki paragraph index (starting from 1)
    - content: the invented object or behavior

    ---------------------------------
    4. USEFULNESS (Missing explanations)
    ---------------------------------

    Identify important source concepts that ARE present in code
    but are mentioned without meaningful explanation or not explained at all.

    Examples:
    - Core service or procedure mentioned but not explained
    - Key endpoint listed without describing its purpose

    For each missing explanation:
    - position: the wiki paragraph index (starting from 1)
    - content: the important concept that lacks explanation

    =====================
    OUTPUT FORMAT (STRICT)
    =====================

    Return ONLY valid JSON.

    The output MUST strictly follow this structure:

    {
      "coverage": {
        "total_items": <integer>,
        "covered_items": <integer>,
        "missing": [
          {
            "position": <integer>,
            "content": "<what is missing>"
          }
        ]
      },
      "correctness": {
        "wrong_count": <integer>,
        "mismatches": [
          {
            "position": <integer>,
            "content": "<what does not match the source>"
          }
        ]
      },
      "hallucination": [
        {
          "position": <integer>,
          "content": "<invented object or behavior>"
        }
      ],
      "usefulness": {
        "missing_explanations": [
          {
            "position": <integer>,
            "content": "<important concept not explained>"
          }
        ]
      }
    }

    =====================
    FINAL CONSTRAINT
    =====================

    - Use integer counts that are internally consistent.
    - Do NOT include any text outside the JSON.
    - If a list is empty, return an empty array [].

tests:
  - name: Stage1 Fact Extraction
    # vars:
      # source_code: file://data/agent.py.txt
      # wiki_md: file://data/agent.py.md
    assert:
          - type: contains-json