# promptfoo v2.1
# Wiki Accuracy & Quality Evaluator
# Stable, deterministic, rubric-free

providers:
  - id: ollama:gpt-oss:120b
    config:
      temperature: 0
      top_p: 1

prompts:
  - |
    You are an automated documentation evaluation engine.

    You are given:
    - SOURCE CODE (Java or SQL)
    - GENERATED WIKI (Markdown)

    --- SOURCE CODE ---
    {{source_code}}

    --- GENERATED WIKI ---
    {{wiki_md}}

    Your task:
    Evaluate whether the Wiki accurately, completely, and usefully documents
    the given source code.

    You MUST:
    - Judge ONLY based on the provided content
    - NOT ask for more input or files
    - NOT include explanations outside JSON
    - Output EXACTLY one JSON object

    Step 1: Detect language from SOURCE CODE
    - "JAVA" if classes / methods / fields are present
    - "SQL" if procedures / tables / parameters are present
    - Otherwise "UNKNOWN"

    Step 2: Score the Wiki (0–25 each)

    Coverage (0–25):
    - Are all major components documented?
    - Java: main classes, public methods, important fields
    - SQL: procedures, parameters, tables, key logic

    Correctness (0–25):
    - Names, signatures, and behavior are accurate
    - No incorrect parameters, return values, or semantics

    Hallucination (0–25):
    - 25 = no invented objects or behavior
    - Deduct heavily for content not present in source

    Usefulness (0–25):
    - Is this Wiki helpful for a developer maintaining the code?
    - Clear structure, accurate summaries, meaningful explanations

    total_score = sum of the four scores (0–100)

    Step 3: Identify missing and hallucinated items
    
    Before scoring, extract:

    KNOWN_ELEMENTS:
    - All procedures
    - All parameters
    - All tables
    - All counters / flags

    Then:
    - missing_items MUST be chosen ONLY from KNOWN_ELEMENTS
    - hallucinated_items MUST reference explicit names in the Wiki

    Step 4: Summarize in one concise sentence
    - Overall quality and accuracy of the Wiki
    - Mention major strengths or weaknesses

    Step 5: Determine PASS / FAIL
    
    FAIL conditions:
    - hallucination_score < 15
    - correctness_score < 15
    - total_score < 70
    Otherwise, PASS

    Finally,
    Output STRICTLY this JSON schema:

    {
      "language": "JAVA" | "SQL" | "UNKNOWN",
      "coverage_score": 0-25,
      "correctness_score": 0-25,
      "hallucination_score": 0-25,
      "usefulness_score": 0-25,
      "total_score": 0-100,
      "missing_items": ["<important undocumented object or concept>"],
      "hallucinated_items": ["<invented object or concept>"],
      "summary": "<one concise sentence>",
      "result": "PASS" | "FAIL"
    }

tests:
  - name: Wiki Alignment Evaluation
    vars:
      # ⚠️ 推荐：提前转 UTF-8，避免乱码
      # iconv -f CP932 -t UTF-8 JIBSOJHJKNCHK.SQL > JIBSOJHJKNCHK.utf8.SQL
      source_code: file://data/JIBSOJHJKNCHK.utf8.SQL
      wiki_md: file://data/JIBSOJHJKNCHK.SQL.md

    # promptfoo 这里只做「最小合法性校验」
    # 真正的评测逻辑在模型输出 JSON 内
    assert:
      - type: regex
        value: '"result"\s*:\s*"(PASS|FAIL)"'
